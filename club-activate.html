<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw Reading Club â€” Activating your membershipâ€¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:#fff7f0;--accent:#ffb86b;--accent-strong:#ff914d;
      --text-main:#3b2824;--text-soft:#8a6a63;
    }
    body {
      font-family: -apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,"Segoe UI",sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background:
        radial-gradient(circle at 5% 0%, #ffe0c0 0%, transparent 55%),
        radial-gradient(circle at 100% 0%, #ffd4d4 0%, transparent 55%),
        linear-gradient(180deg,#fff7f0 0%,#fff2e7 40%,#fff8f2 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }
    .card {
      width: 100%;
      max-width: 420px;
      border-radius: 24px;
      background: rgba(255,248,240,0.98);
      box-shadow: 0 24px 60px rgba(210,145,110,0.35);
      padding: 22px 20px 18px;
      text-align: center;
    }
    .emoji {
      font-size: 32px;
      margin-bottom: 10px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    p {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .status {
      font-size: 12px;
      margin-top: 6px;
      color: #9a6747;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#ffb86b,#ff914d);
      color: #4a251a;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      text-decoration: none;
      box-shadow: 0 18px 40px rgba(214,139,86,0.65);
    }
    .btn span { margin-left: 4px; }
    .error {
      color: #b3261e;
      font-size: 12px;
      margin-top: 6px;
    }
    @media (max-width:480px){
      .card{padding:18px 16px 16px;border-radius:20px;}
      h1{font-size:18px;}
      p{font-size:12px;}
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="emoji">ðŸ“š</div>
    <h1>Activating your Reading Club</h1>
    <p id="message">
      Please wait a moment while we connect your payment to your CalmPaw account.
    </p>
    <p class="status" id="status-text">Checking your login & membershipâ€¦</p>
    <div id="actions" style="display:none;">
      <a href="auth.html?redirect=%2Fclub-activate.html" class="btn">
        Log in again <span>â†’</span>
      </a>
      <p class="error" id="error-text"></p>
    </div>
  </div>

  <script>
    const API_BASE = "https://calmpaw-auth.sophieinbg.workers.dev";

    async function activateClub() {
      const msg = document.getElementById("message");
      const status = document.getElementById("status-text");
      const actions = document.getElementById("actions");
      const errorText = document.getElementById("error-text");

      const token = localStorage.getItem("calmpaw_token");
      if (!token) {
        status.textContent = "You are not logged in.";
        msg.textContent = "Please log in so we can attach the Reading Club to your account.";
        actions.style.display = "block";
        return;
      }

      try {
        status.textContent = "Confirming your accountâ€¦";
        const meRes = await fetch(API_BASE + "/auth/me", {
          headers: { "Authorization": "Bearer " + token }
        });
        const meData = await meRes.json();
        if (!meRes.ok || !meData.ok) {
          status.textContent = "We could not confirm your login.";
          msg.textContent = "Please log in again, then return to this page.";
          actions.style.display = "block";
          return;
        }

        status.textContent = "Activating your Reading Clubâ€¦";
        const res = await fetch(API_BASE + "/club/activate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ product_slug: "reading_club" })
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          status.textContent = "We couldn't finish activation.";
          msg.textContent = "Your payment went through, but we could not activate the Reading Club automatically.";
          actions.style.display = "block";
          errorText.textContent = "Please contact support with your email and payment receipt, and we will fix it manually.";
          return;
        }

        status.textContent = "Membership active.";
        msg.textContent = "Your Reading Club subscription is now active. Redirecting you to this month's readerâ€¦";
        setTimeout(() => {
          window.location.href = "/club-subscribed.html";
        }, 1200);
      } catch (e) {
        console.error(e);
        status.textContent = "Something went wrong.";
        msg.textContent = "We hit a technical error while activating your membership.";
        actions.style.display = "block";
        errorText.textContent = "If this keeps happening, please contact support with your payment receipt.";
      }
    }

    document.addEventListener("DOMContentLoaded", activateClub);
  </script>
</body>
</html>
