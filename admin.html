<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw ç®¡ç†åå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #ffe4c7 0%, #fff7f0 45%, #fff7f0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: #3b2824;
    }
    .shell {
      width: 100%;
      max-width: 980px;
      background: #fff7f0;
      border-radius: 28px;
      box-shadow: 0 26px 80px rgba(210,145,96,0.45);
      border: 1px solid #f3d9c4;
      padding: 24px 24px 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-badge {
      width: 36px; height: 36px;
      border-radius: 999px;
      background: conic-gradient(from 230deg,#ffb86b,#ff914d,#ffd19c,#ffb86b);
      display:flex; align-items:center; justify-content:center;
      font-size: 20px;
    }
    .logo-text-main { font-weight: 650; font-size: 18px; }
    .logo-text-sub { font-size: 12px; color:#8a6a63; }
    .pill {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #fff0dd;
      border: 1px solid #f3d9c4;
      color:#8a6a63;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 24px;
    }
    @media (max-width: 800px) {
      .shell { padding: 20px 18px 18px; }
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: #ffffff;
      border-radius: 22px;
      border: 1px solid #f3d9c4;
      padding: 18px 18px 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.03);
    }
    .card h2 {
      font-size: 16px;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card p.small {
      font-size: 12px;
      color:#8a6a63;
      line-height: 1.5;
      margin-bottom: 10px;
    }
    .hint-box {
      background:#fff7ed;
      border-radius: 18px;
      border:1px dashed #fbbf77;
      padding:10px 12px;
      font-size: 12px;
      color:#8a6a63;
      margin-bottom: 14px;
      white-space: pre-line;
    }
    label {
      font-size: 12px;
      color:#6d4c45;
      display:block;
      margin-bottom: 4px;
    }
    input[type="email"],
    input[type="password"],
    input[type="text"],
    input[type="number"] {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #f3d9c4;
      padding: 9px 12px;
      font-size: 13px;
      outline: none;
      background:#fffaf5;
    }
    input:focus {
      border-color:#ffb86b;
      box-shadow: 0 0 0 1px rgba(255,184,107,0.5);
    }
    .btn {
      display:inline-flex;
      justify-content:center;
      align-items:center;
      padding: 8px 18px;
      border-radius: 999px;
      border:none;
      font-size:13px;
      font-weight:550;
      cursor:pointer;
      background:#ff914d;
      color:white;
      box-shadow:0 12px 30px rgba(255,145,77,0.45);
      margin-top:8px;
    }
    .btn.secondary {
      background:#fff7f0;
      color:#8a6a63;
      box-shadow:none;
      border:1px solid #f3d9c4;
    }
    .btn:disabled {
      opacity:0.6;
      cursor:default;
      box-shadow:none;
    }
    .error {
      font-size: 12px;
      margin-top: 8px;
      color:#b91c1c;
    }
    .success {
      font-size: 12px;
      margin-top: 8px;
      color:#15803d;
    }
    .field-row {
      margin-bottom: 10px;
    }
    .badge {
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      background:#f3d9c4;
      color:#6b4b44;
    }
    .tag {
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid #f3d9c4;
      color:#8a6a63;
      background:#fffaf5;
    }
    .checkbox-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px 16px;
      margin:6px 0 4px;
      font-size:12px;
    }
    .checkbox-row label {
      display:flex;
      align-items:center;
      gap:4px;
      margin:0;
    }
    .muted {
      font-size:11px;
      color:#a58b84;
    }
    .list {
      margin-top:6px;
      max-height:210px;
      overflow:auto;
      font-size:12px;
    }
    .list-item {
      padding:6px 0;
      border-bottom:1px dashed #f3d9c4;
    }
    .list-item:last-child { border-bottom:none; }
    code {
      font-size:11px;
      background:#f3d9c4;
      padding:1px 5px;
      border-radius:999px;
    }
    .top-right {
      display:flex;
      align-items:center;
      gap:10px;
      font-size:11px;
      color:#8a6a63;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="logo">
        <div class="logo-badge">ğŸ¾</div>
        <div>
          <div class="logo-text-main">CalmPaw ç®¡ç†å‘˜</div>
          <div class="logo-text-sub">ç»™å®¢æˆ·å¼€è®­ç»ƒè®¡åˆ’ / è¡¥å• / æŸ¥çœ‹è®¢å•</div>
        </div>
      </div>
      <div class="top-right" id="topRight">
        <span class="pill" id="adminStatus">æœªç™»å½•</span>
        <button class="btn secondary" id="logoutBtn" style="display:none;">é€€å‡º</button>
      </div>
    </div>

    <div class="grid">
      <!-- å·¦ï¼šç™»å½• & æœç´¢ -->
      <div class="card">
        <h2>ç™»å½•åå°</h2>
        <p class="small">é¦–æ¬¡ç™»å½•è¯·ç”¨é»˜è®¤è´¦å·ï¼Œç™»å½•æˆåŠŸåå†åœ¨æ•°æ®åº“é‡Œæ”¹æˆä½ è‡ªå·±çš„é‚®ç®±å’Œå¯†ç ã€‚</p>
        <div class="hint-box">
ç¬¬ä¸€æ¬¡ç™»å½•ï¼Ÿ  
é»˜è®¤è´¦å·ï¼š  
<code>admin@calmpaw.local / CalmPawAdmin123!</code>
ï¼ˆå»ºè®®æ”¹å®Œå¯†ç åå†åˆ é™¤é»˜è®¤ç®¡ç†å‘˜ï¼‰
        </div>

        <div class="field-row">
          <label>ç®¡ç†å‘˜é‚®ç®±</label>
          <input type="email" id="adminEmail" value="admin@calmpaw.local" />
        </div>
        <div class="field-row">
          <label>å¯†ç </label>
          <input type="password" id="adminPassword" value="CalmPawAdmin123!" />
        </div>
        <button class="btn" id="loginBtn">ç™»å…¥</button>
        <div id="loginMsg" class="error" style="display:none;"></div>

        <hr style="border:none;border-top:1px dashed #f3d9c4;margin:16px 0;" />

        <h2>æœç´¢ç”¨æˆ·</h2>
        <p class="small">å…ˆç™»å½•ï¼Œå†æ ¹æ®å®¢æˆ·é‚®ç®±æŸ¥ä»–çš„è®¡åˆ’å’Œè®¢å•ï¼›ä¸‹é¢å¯ä»¥ç›´æ¥å‹¾é€‰è®­ç»ƒè®¡åˆ’ï¼Œç‚¹å‡»ä¿å­˜ã€‚</p>
        <div class="field-row">
          <label>å®¢æˆ·é‚®ç®±</label>
          <input type="email" id="searchEmail" placeholder="customer@example.com" />
        </div>
        <button class="btn secondary" id="searchBtn">æœç´¢</button>
        <div id="searchMsg" class="error" style="display:none;"></div>
      </div>

      <!-- å³ï¼šç”¨æˆ·è¯¦æƒ… & è®¢å• -->
      <div class="card">
        <h2>å®¢æˆ·è¯¦æƒ… & è®¡åˆ’</h2>
        <div id="userPanel">
          <p class="small">å°šæœªé€‰æ‹©ç”¨æˆ·ï¼Œè¯·åœ¨å·¦ä¾§è¾“å…¥å®¢æˆ·é‚®ç®±å¹¶ç‚¹å‡»ã€Œæœç´¢ã€ã€‚</p>
        </div>
        <div id="userMsg" class="success" style="display:none;"></div>

        <hr style="border:none;border-top:1px dashed #f3d9c4;margin:14px 0;" />

        <h2>æœ€è¿‘è®¢å•</h2>
        <p class="small">å±•ç¤ºç³»ç»Ÿä¸­æœ€è¿‘çš„è®¢å•è®°å½•ï¼Œæ–¹ä¾¿å¯¹ä¸Šè´¦ã€‚</p>
        <button class="btn secondary" id="ordersBtn" style="margin-bottom:6px;">åˆ·æ–°è®¢å•åˆ—è¡¨</button>
        <div class="list" id="ordersList"></div>
      </div>
    </div>
  </div>

  <script>
    // ======== è¿™é‡Œæ¢æˆä½ çš„ Worker åŸºç¡€åœ°å€ ========
    const API_BASE = 'https://calmpawcoach.com/w/auth';
    // å¦‚æœä½  Worker ä¸æ˜¯è¿™ä¸ªè·¯å¾„ï¼Œå°±æ”¹æˆçœŸå®çš„é‚£ä¸ªï¼Œæ¯”å¦‚ï¼š
    // const API_BASE = 'https://calmpawcoach.com/w/auth';

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginMsg = document.getElementById('loginMsg');
    const adminStatus = document.getElementById('adminStatus');
    const searchBtn = document.getElementById('searchBtn');
    const searchMsg = document.getElementById('searchMsg');
    const userPanel = document.getElementById('userPanel');
    const userMsg = document.getElementById('userMsg');
    const ordersBtn = document.getElementById('ordersBtn');
    const ordersList = document.getElementById('ordersList');

    function getToken() {
      return localStorage.getItem('calmpaw_admin_token') || '';
    }
    function setToken(t) {
      if (!t) {
        localStorage.removeItem('calmpaw_admin_token');
      } else {
        localStorage.setItem('calmpaw_admin_token', t);
      }
      updateAdminStatus();
    }

    function updateAdminStatus() {
      const token = getToken();
      if (!token) {
        adminStatus.textContent = 'æœªç™»å½•';
        adminStatus.style.background = '#fff0dd';
        logoutBtn.style.display = 'none';
        return;
      }
      adminStatus.textContent = 'å·²ç™»å½•ï¼ˆç®¡ç†å‘˜ï¼‰';
      adminStatus.style.background = '#dcfce7';
      logoutBtn.style.display = 'inline-flex';
    }

    async function loginAdmin() {
      loginMsg.style.display = 'none';
      loginMsg.textContent = '';
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      if (!email || !password) {
        loginMsg.textContent = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
        loginMsg.style.display = 'block';
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'ç™»å½•ä¸­...';

      try {
        const res = await fetch(API_BASE + '/admin/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('login parse error', text);
          throw new Error('åå°è¿”å›çš„ä¸æ˜¯ JSONï¼š' + text.slice(0, 120));
        }

        if (!res.ok || !data.token) {
          loginMsg.textContent = data.error || 'ç™»å½•å¤±è´¥';
          loginMsg.style.display = 'block';
          return;
        }

        setToken(data.token);
        loginMsg.className = 'success';
        loginMsg.textContent = 'ç™»å½•æˆåŠŸ';
        loginMsg.style.display = 'block';
      } catch (err) {
        console.error(err);
        loginMsg.className = 'error';
        loginMsg.textContent = 'è¯·æ±‚å¤±è´¥ï¼š' + err.message;
        loginMsg.style.display = 'block';
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å…¥';
      }
    }

    async function authFetch(path, options = {}) {
      const token = getToken();
      if (!token) throw new Error('æœªç™»å½•ç®¡ç†å‘˜');

      const headers = options.headers ? { ...options.headers } : {};
      headers['Authorization'] = 'Bearer ' + token;
      if (!headers['Content-Type'] && options.method && options.method !== 'GET') {
        headers['Content-Type'] = 'application/json';
      }

      const res = await fetch(API_BASE + path, { ...options, headers });
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error('parse error', text);
        throw new Error('å“åº”ä¸æ˜¯ JSONï¼š' + text.slice(0, 120));
      }
      if (!res.ok) {
        const msg = data.error || 'è¯·æ±‚å¤±è´¥';
        throw new Error(msg);
      }
      return data;
    }

    async function searchUser() {
      searchMsg.style.display = 'none';
      userMsg.style.display = 'none';
      const emailInput = document.getElementById('searchEmail');
      const email = (emailInput.value || '').trim().toLowerCase();
      if (!email) {
        searchMsg.textContent = 'è¯·è¾“å…¥è¦æœç´¢çš„å®¢æˆ·é‚®ç®±';
        searchMsg.style.display = 'block';
        return;
      }
      searchBtn.disabled = true;
      searchBtn.textContent = 'æœç´¢ä¸­...';

      try {
        const data = await authFetch('/admin/api/search-user?email=' + encodeURIComponent(email));
        if (!data || !data.user) {
          userPanel.innerHTML = '<p class="small">æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªé‚®ç®±çš„ç”¨æˆ·ã€‚</p>';
          return;
        }
        renderUserPanel(data.user, data.plans, data.orders || []);
      } catch (err) {
        console.error(err);
        searchMsg.textContent = err.message;
        searchMsg.style.display = 'block';
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'æœç´¢';
      }
    }

    function renderUserPanel(user, plans, orders) {
      const html = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div>
            <div style="font-size:14px;font-weight:600;">${user.email}</div>
            <div class="muted">ID: ${user.id ?? '-'}</div>
          </div>
          <span class="badge">å®¢æˆ·</span>
        </div>
        <div class="field-row" style="margin-top:8px;">
          <label>è®­ç»ƒè®¡åˆ’ï¼ˆå‹¾é€‰å³å¼€é€šï¼‰</label>
          <div class="checkbox-row">
            <label><input type="checkbox" id="plan_barking" ${plans.plan_barking ? 'checked' : ''}/> Barking 7 å¤©</label>
            <label><input type="checkbox" id="plan_leash" ${plans.plan_leash ? 'checked' : ''}/> Leash 10 å¤©</label>
            <label><input type="checkbox" id="plan_puppy" ${plans.plan_puppy ? 'checked' : ''}/> Puppy 14 å¤©</label>
            <label><input type="checkbox" id="plan_bundle" ${plans.plan_bundle ? 'checked' : ''}/> ä¸‰ä¸ªæ‰“åŒ…</label>
          </div>
          <div class="muted">åªä¿®æ”¹è®¿é—®æƒé™ï¼Œä¸ä¼šå½±å“çœŸå®æ”¶æ¬¾ã€‚</div>
          <button class="btn" id="savePlansBtn">ä¿å­˜è®¡åˆ’</button>
        </div>
        <div style="margin-top:10px;">
          <label>æœ€è¿‘è®¢å•ï¼ˆæŒ‰é‚®ç®±ï¼‰</label>
          <div class="list">
            ${
              orders.length === 0
                ? '<div class="muted">æš‚æ— è®¢å•è®°å½•ã€‚</div>'
                : orders
                    .map(o => {
                      const amt = o.amount_cents ? (o.amount_cents / 100).toFixed(2) : '-';
                      return `<div class="list-item">
                        <div>${o.product_code || '-'} Â· ${amt} ${o.currency || ''}</div>
                        <div class="muted">${o.created_at || ''} Â· æ¥æºï¼š${o.source || '-'}</div>
                      </div>`;
                    })
                    .join('')
            }
          </div>
        </div>
      `;
      userPanel.innerHTML = html;

      const saveBtn = document.getElementById('savePlansBtn');
      saveBtn.addEventListener('click', savePlans);
    }

    async function savePlans() {
      userMsg.style.display = 'none';
      const email = (document.getElementById('searchEmail').value || '').trim().toLowerCase();
      if (!email) return;

      const payload = {
        email,
        plan_barking: document.getElementById('plan_barking').checked,
        plan_leash: document.getElementById('plan_leash').checked,
        plan_puppy: document.getElementById('plan_puppy').checked,
        plan_bundle: document.getElementById('plan_bundle').checked,
      };

      const btn = document.getElementById('savePlansBtn');
      btn.disabled = true;
      btn.textContent = 'ä¿å­˜ä¸­...';

      try {
        await authFetch('/admin/api/update-user', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        userMsg.className = 'success';
        userMsg.textContent = 'å·²ä¿å­˜è®¡åˆ’æƒé™ã€‚';
        userMsg.style.display = 'block';
      } catch (err) {
        console.error(err);
        userMsg.className = 'error';
        userMsg.textContent = 'ä¿å­˜å¤±è´¥ï¼š' + err.message;
        userMsg.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ä¿å­˜è®¡åˆ’';
      }
    }

    async function loadOrders() {
      ordersList.innerHTML = '<div class="muted">åŠ è½½ä¸­...</div>';
      try {
        const data = await authFetch('/admin/api/orders?limit=20');
        const orders = data.orders || [];
        if (orders.length === 0) {
          ordersList.innerHTML = '<div class="muted">æš‚æ— è®¢å•è®°å½•ã€‚</div>';
          return;
        }
        ordersList.innerHTML = orders
          .map(o => {
            const amt = o.amount_cents ? (o.amount_cents / 100).toFixed(2) : '-';
            return `<div class="list-item">
              <div>${o.email || '-'} Â· ${o.product_code || '-'} Â· ${amt} ${o.currency || ''}</div>
              <div class="muted">${o.created_at || ''} Â· æ¥æºï¼š${o.source || '-'}</div>
            </div>`;
          })
          .join('');
      } catch (err) {
        console.error(err);
        ordersList.innerHTML = '<div class="muted">åŠ è½½å¤±è´¥ï¼š' + err.message + '</div>';
      }
    }

    loginBtn.addEventListener('click', loginAdmin);
    logoutBtn.addEventListener('click', () => {
      setToken('');
      userPanel.innerHTML = '<p class="small">å·²é€€å‡ºï¼Œè¯·é‡æ–°ç™»å½•ã€‚</p>';
    });
    searchBtn.addEventListener('click', searchUser);
    ordersBtn.addEventListener('click', loadOrders);

    updateAdminStatus();
  </script>
</body>
</html>
