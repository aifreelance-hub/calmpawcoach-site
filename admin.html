<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw ç®¡ç†å‘˜åå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ç»Ÿè®¡å›¾è¡¨ç”¨çš„ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #fff7f0;
      --bg-soft: #ffeede;
      --accent: #ffb86b;
      --accent-strong: #ff914d;
      --accent-soft: #ffe0b8;
      --text-main: #3b2824;
      --text-soft: #8a6a63;
      --border-soft: #f3d9c4;
      --radius-lg: 26px;
      --radius-md: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 26px 80px rgba(191, 128, 89, 0.28);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #ffe0c7 0%, #fff7f0 40%, #fff 100%);
      display: flex;
      justify-content: center;
      padding: 32px 16px;
      color: var(--text-main);
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      background: rgba(255, 247, 240, 0.96);
      border-radius: 32px;
      box-shadow: var(--shadow-soft);
      padding: 28px 26px 30px;
      position: relative;
      overflow: hidden;
    }

    .shell::before {
      content: "";
      position: absolute;
      inset: -120px;
      background:
        radial-gradient(circle at top left, rgba(255, 198, 145, .25), transparent 55%),
        radial-gradient(circle at bottom right, rgba(255, 177, 109, .25), transparent 55%);
      pointer-events: none;
      z-index: -1;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: conic-gradient(from 210deg, #ffb86b, #ff914d, #ffe5c9, #ffb86b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 10px 30px rgba(191, 128, 89, 0.4);
    }

    .brand-main {
      font-size: 18px;
      font-weight: 700;
    }

    .brand-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .login-status-pill {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.05);
      border: 1px solid rgba(22, 163, 74, 0.35);
      color: #15803d;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .login-status-pill.off {
      background: rgba(148, 163, 184, 0.08);
      border-color: rgba(148, 163, 184, 0.5);
      color: #4b5563;
    }

    .login-status-pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #16a34a;
    }

    .login-status-pill.off span.dot {
      background: #9ca3af;
    }

    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
    }

    @media (max-width: 860px) {
      .shell { padding: 20px 16px 22px; }
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #fff;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(250, 204, 171, 0.9);
      padding: 18px 18px 16px;
      margin-bottom: 14px;
      box-shadow: 0 14px 40px rgba(191, 128, 89, 0.12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
    }

    .card-sub {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--text-soft);
    }

    input[type="email"],
    input[type="password"],
    input[type="text"],
    select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: #fff7f0;
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus,
    select:focus {
      border-color: #f97316;
      box-shadow: 0 0 0 1px rgba(248, 113, 22, 0.25);
      background: #fffdf8;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #ffb86b, #ff914d);
      color: #422006;
      box-shadow: 0 14px 35px rgba(248, 113, 22, 0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 18px 40px rgba(248, 113, 22, 0.45);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary {
      background: #fff7f0;
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid rgba(248, 113, 22, 0.25);
    }

    .badge-tip {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(248, 113, 22, 0.45);
      background: rgba(255, 247, 237, 0.9);
      color: #9a3412;
    }

    .msg {
      margin-top: 8px;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 12px;
      display: none;
    }

    .msg.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .msg.success {
      background: #ecfdf3;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(248, 113, 22, 0.08);
      color: #9a3412;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #f97316;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(248, 189, 132, 0.35);
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: var(--text-soft);
      font-size: 11px;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .muted {
      color: #9ca3af;
      font-size: 11px;
    }

    .tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.08);
      color: #1d4ed8;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip-check {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 22, 0.4);
      background: rgba(255, 247, 237, 0.9);
      cursor: pointer;
    }

    .chip-check input {
      margin: 0;
    }

    .two-col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    @media (max-width: 680px) {
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    .stat-cards {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .stat-cards {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 720px) {
      .stat-cards {
        grid-template-columns: 1fr 1fr;
      }
    }
    @media (max-width: 540px) {
      .stat-cards {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      border-radius: 18px;
      padding: 9px 11px;
      background: #fff7f0;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 700;
    }

    .stat-sub {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 1px;
    }

    .small-input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .small-input-row input {
      flex: 1;
    }

    .small-input-row select {
      width: 90px;
    }

    .scroll-y {
      max-height: 200px;
      overflow-y: auto;
    }

    .scroll-y-logs {
      max-height: 220px;
      overflow-y: auto;
    }

    .mt-6 { margin-top: 6px; }
    .mt-10 { margin-top: 10px; }

  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="brand">
        <div class="logo-dot">ğŸ¾</div>
        <div>
          <div class="brand-main">CalmPaw ç®¡ç†å‘˜</div>
          <div class="brand-sub">ç»™å®¢æˆ·å¼€è®­ç»ƒè®¡åˆ’ / è¡¥å• / çœ‹ç»Ÿè®¡</div>
        </div>
      </div>
      <div id="loginStatusPill" class="login-status-pill off">
        <span class="dot"></span>
        <span id="loginStatusText">æœªç™»å½•</span>
      </div>
    </header>

    <div class="grid">
      <!-- å·¦ä¾§ï¼šç™»å½• + æœç´¢å®¢æˆ· -->
      <div>
        <!-- 1. ç®¡ç†å‘˜ç™»å½• -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">1. ç®¡ç†å‘˜ç™»å½•</div>
            <button id="firstLoginBtn" class="btn-secondary" style="font-size:11px;padding:4px 9px;">
              é¦–æ¬¡ç™»å½•è´¦å·
            </button>
          </div>
          <div class="card-sub">
            ç¬¬ä¸€æ¬¡ä½¿ç”¨è¯·å…ˆç”¨é»˜è®¤è´¦å·ç™»å½•ï¼š<br />
            <span class="badge-tip">
              admin@calmpaw.local / CalmPawAdmin123!
            </span><br />
            ç™»å½•æˆåŠŸåå¯ä»¥åœ¨æ•°æ®åº“é‡Œæ”¹æˆä½ è‡ªå·±çš„é‚®ç®±å’Œå¯†ç ã€‚
          </div>

          <label for="adminEmail">ç®¡ç†å‘˜é‚®ç®±</label>
          <input id="adminEmail" type="email" placeholder="admin@calmpaw.local" />

          <label for="adminPassword" style="margin-top:8px;">å¯†ç </label>
          <input id="adminPassword" type="password" placeholder="ç®¡ç†å‘˜å¯†ç " />

          <button id="loginBtn" class="btn" style="margin-top:10px;width:100%;">ç™»å…¥åå°</button>

          <div id="loginMsg" class="msg"></div>
        </div>

        <!-- 2. æœç´¢å®¢æˆ·é‚®ç®± -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">2. æœç´¢å®¢æˆ·é‚®ç®±</div>
          </div>
          <div class="card-sub">
            å…ˆç™»å½•åå°ï¼Œå†åœ¨è¿™é‡Œè¾“å…¥å®¢æˆ·é‚®ç®±ï¼ŒæŸ¥çœ‹å¹¶ä¿®æ”¹ä»–ä»¬çš„è®­ç»ƒè®¡åˆ’ / æ‰‹åŠ¨è¡¥å•ã€‚
          </div>

          <label for="customerEmail">å®¢æˆ·é‚®ç®±</label>
          <input id="customerEmail" type="email" placeholder="customer@example.com" />

          <button id="searchUserBtn" class="btn" style="margin-top:10px;width:100%;">æœç´¢å®¢æˆ·</button>

          <div id="searchUserMsg" class="msg"></div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå®¢æˆ·è¯¦æƒ… / è®¢å• / ç»Ÿè®¡ / ç®¡ç†å‘˜ç­‰ -->
      <div>
        <!-- 3. å®¢æˆ·ä¿¡æ¯ & è®­ç»ƒè®¡åˆ’ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">3. å®¢æˆ·ä¿¡æ¯ & è®­ç»ƒè®¡åˆ’</div>
            <div id="currentUserChip" class="pill" style="display:none;">
              <span class="pill-dot"></span>
              <span id="currentUserEmail"></span>
            </div>
          </div>
          <div class="card-sub">
            å…ˆåœ¨å·¦ä¾§æœç´¢å®¢æˆ·é‚®ç®±ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå®¢æˆ·çš„è®­ç»ƒè®¡åˆ’ã€‚ä½ å¯ä»¥æ‰‹åŠ¨å¼€é€š / å…³é—­ã€‚
          </div>

          <div id="noUserHint" class="muted">
            è¿˜æ²¡æœ‰é€‰æ‹©å®¢æˆ·ã€‚è¯·åœ¨å·¦ä¾§è¾“å…¥é‚®ç®±å¹¶ç‚¹å‡»ã€Œæœç´¢å®¢æˆ·ã€ã€‚
          </div>

          <div id="userDetailArea" style="display:none;">
            <div class="chips">
              <label class="chip-check">
                <input type="checkbox" id="planBarking" />
                <span>å¼€é€šï¼šå å«è®­ç»ƒè®¡åˆ’ï¼ˆ$19ï¼‰</span>
              </label>
              <label class="chip-check">
                <input type="checkbox" id="planLeash" />
                <span>å¼€é€šï¼šç‰µå¼•è®­ç»ƒè®¡åˆ’ï¼ˆ$29ï¼‰</span>
              </label>
              <label class="chip-check">
                <input type="checkbox" id="planPuppy" />
                <span>å¼€é€šï¼šå¹¼çŠ¬åŸºç¡€ï¼ˆ$19ï¼‰</span>
              </label>
              <label class="chip-check">
                <input type="checkbox" id="planBundle" />
                <span>å…¨éƒ¨è®­ç»ƒå¥—è£…ï¼ˆå®¢æˆ·å‰ç«¯ $49ï¼‰</span>
              </label>
            </div>

            <button id="savePlansBtn" class="btn" style="margin-top:10px;">ä¿å­˜è®­ç»ƒè®¡åˆ’</button>
            <div id="savePlansMsg" class="msg"></div>
          </div>
        </div>

        <!-- 4. æœ€è¿‘è®¢å• -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">4. æœ€è¿‘è®¢å•ï¼ˆå¯é€‰ï¼‰</div>
            <button id="refreshOrdersBtn" class="btn-secondary" style="font-size:11px;padding:4px 9px;">
              åˆ·æ–°è®¢å•åˆ—è¡¨
            </button>
          </div>
          <div class="card-sub">
            è¿™é‡Œä¼šä» <code>orders</code> è¡¨è¯»æœ€è¿‘ 50 æ¡è®°å½•ï¼Œä¸»è¦æ–¹ä¾¿ä½ å¿«é€ŸæŸ¥æŸä¸ªé‚®ç®±éƒ½ä¹°äº†ä»€ä¹ˆäº§å“ã€é‡‘é¢æ˜¯å¤šå°‘ã€‚
          </div>

          <div class="scroll-y">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>æ—¶é—´</th>
                  <th>é‚®ç®±</th>
                  <th>äº§å“</th>
                  <th>é‡‘é¢</th>
                  <th>æ¥æº</th>
                </tr>
              </thead>
              <tbody id="ordersTbody">
                <tr><td colspan="6" class="muted">æš‚æ— æ•°æ®</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 5. å®¢æˆ·åˆ—è¡¨ & åŸºæœ¬ç»Ÿè®¡ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">5. å®¢æˆ·åˆ—è¡¨ & æ”¶å…¥ç»Ÿè®¡</div>
            <button id="refreshStatsBtn" class="btn-secondary" style="font-size:11px;padding:4px 9px;">
              åˆ·æ–°ç»Ÿè®¡
            </button>
          </div>
          <div class="card-sub">
            ä¸ŠåŠéƒ¨åˆ†æ˜¯æ”¶å…¥å’Œè®¢å•ç»Ÿè®¡ï¼›ä¸‹åŠéƒ¨åˆ†æ˜¾ç¤ºæœ€è¿‘æ³¨å†Œçš„å®¢æˆ·åˆ—è¡¨ï¼ˆä» <code>calmpaw_users</code> è¡¨è¯»å–ï¼‰ã€‚
          </div>

          <!-- ç»Ÿè®¡å¡ç‰‡ -->
          <div class="stat-cards">
            <div class="stat-card">
              <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
              <div id="statUsersTotal" class="stat-value">-</div>
              <div class="stat-sub">calmpaw_users</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">æ€»è®¢å•æ•°</div>
              <div id="statOrdersTotal" class="stat-value">-</div>
              <div class="stat-sub">orders</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">æ€»æ”¶å…¥ï¼ˆUSDï¼‰</div>
              <div id="statRevenueTotal" class="stat-value">-</div>
              <div class="stat-sub">ç´¯è®¡é‡‘é¢</div>
            </div>
          </div>

          <div class="two-col mt-10">
            <div>
              <div class="muted">æœ€è¿‘ 7 å¤©æ”¶å…¥ï¼ˆUSDï¼‰</div>
              <div id="statRevenue7d" style="font-size:14px;font-weight:600;">-</div>
              <canvas id="revenueChart" style="margin-top:6px;max-height:150px;"></canvas>
            </div>
            <div>
              <div class="muted">æœ€è¿‘æ³¨å†Œå®¢æˆ·ï¼ˆæœ€å¤š 20 ä¸ªï¼‰</div>
              <div class="scroll-y" style="max-height:160px;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>é‚®ç®±</th>
                    </tr>
                  </thead>
                  <tbody id="recentUsersTbody">
                    <tr><td colspan="2" class="muted">ç‚¹å‡»ã€Œåˆ·æ–°ç»Ÿè®¡ã€ååŠ è½½</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 6. ç®¡ç†å‘˜ & æ“ä½œæ—¥å¿— -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">6. ç®¡ç†å‘˜ & æ“ä½œæ—¥å¿—</div>
            <button id="refreshLogsBtn" class="btn-secondary" style="font-size:11px;padding:4px 9px;">
              åˆ·æ–°æ—¥å¿—
            </button>
          </div>
          <div class="card-sub">
            åªæœ‰ role=super çš„ç®¡ç†å‘˜æ‰å¯ä»¥åˆ›å»ºæ–°çš„åå°è´¦å·ã€‚æ—¥å¿—ä¼šè®°å½•åå°çš„å…³é”®æ“ä½œï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚
          </div>

          <div class="two-col">
            <!-- ç®¡ç†å‘˜åˆ—è¡¨ / åˆ›å»º -->
            <div>
              <div class="muted">ç®¡ç†å‘˜åˆ—è¡¨</div>
              <div class="scroll-y" style="max-height:120px;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>é‚®ç®±</th>
                      <th>è§’è‰²</th>
                    </tr>
                  </thead>
                  <tbody id="adminsTbody">
                    <tr><td colspan="3" class="muted">ç‚¹å‡»ã€Œåˆ·æ–°æ—¥å¿—ã€ååŠ è½½</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="muted" style="margin-top:6px;">åˆ›å»ºæ–°ç®¡ç†å‘˜ï¼ˆä»… superï¼‰</div>
              <div class="small-input-row">
                <input id="newAdminEmail" type="email" placeholder="new-admin@example.com" />
                <select id="newAdminRole">
                  <option value="admin">admin</option>
                  <option value="viewer">viewer</option>
                </select>
              </div>
              <input id="newAdminPassword" type="password" placeholder="æ–°ç®¡ç†å‘˜å¯†ç " style="margin-top:6px;" />
              <button id="createAdminBtn" class="btn" style="margin-top:6px;width:100%;">åˆ›å»ºç®¡ç†å‘˜</button>
              <div id="createAdminMsg" class="msg"></div>
            </div>

            <!-- æ—¥å¿— -->
            <div>
              <div class="muted">åå°æ“ä½œæ—¥å¿—ï¼ˆæœ€è¿‘ 50 æ¡ï¼‰</div>
              <div class="scroll-y-logs">
                <table>
                  <thead>
                    <tr>
                      <th>æ—¶é—´</th>
                      <th>æ“ä½œäºº</th>
                      <th>åŠ¨ä½œ</th>
                      <th>ç›®æ ‡é‚®ç®±</th>
                    </tr>
                  </thead>
                  <tbody id="logsTbody">
                    <tr><td colspan="4" class="muted">ç‚¹å‡»ã€Œåˆ·æ–°æ—¥å¿—ã€ååŠ è½½</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- /å³ä¾§ -->
    </div> <!-- /grid -->
  </div>

  <script>
    // ===== æ ¹æ®ä½ å½“å‰ Worker åœ°å€ä¿®æ”¹è¿™é‡Œ =====
    // å¦‚æœä½ åŸæ¥ admin.html é‡Œå·²ç»æœ‰ä¸€ä¸ª API_BASEï¼Œå¹¶ä¸”èƒ½æ­£å¸¸ç™»å½•ï¼Œ
    // å°±æŠŠé‚£ä¸€è¡Œåœ°å€å¤åˆ¶åˆ°è¿™é‡Œæ›¿æ¢æ‰å³å¯ã€‚
    const API_BASE = 'https://calmpaw-auth.sophieinbg.workers.dev';

    let adminToken = null;
    let revenueChart = null;
    let currentUserEmail = null;

    function setAdminToken(token) {
      adminToken = token;
      if (token) {
        localStorage.setItem('calmpaw_admin_token', token);
        updateLoginStatus(true);
      } else {
        localStorage.removeItem('calmpaw_admin_token');
        updateLoginStatus(false);
      }
    }

    function getAdminToken() {
      if (adminToken) return adminToken;
      const stored = localStorage.getItem('calmpaw_admin_token');
      if (stored) {
        adminToken = stored;
        updateLoginStatus(true);
      }
      return adminToken;
    }

    function updateLoginStatus(loggedIn) {
      const pill = document.getElementById('loginStatusPill');
      const text = document.getElementById('loginStatusText');
      if (!pill || !text) return;
      if (loggedIn) {
        pill.classList.remove('off');
        text.textContent = 'å·²ç™»å½•';
      } else {
        pill.classList.add('off');
        text.textContent = 'æœªç™»å½•';
      }
    }

    async function authFetch(path, options = {}) {
      const token = getAdminToken();
      if (!token) throw new Error('NO_ADMIN_TOKEN');
      const headers = Object.assign(
        {
          'Authorization': 'Bearer ' + token
        },
        options.headers || {}
      );
      const resp = await fetch(API_BASE + path, {
        ...options,
        headers
      });
      return resp;
    }

    function showMsg(el, type, text) {
      if (!el) return;
      el.style.display = 'block';
      el.classList.remove('error', 'success');
      el.classList.add(type === 'error' ? 'error' : 'success');
      el.textContent = text;
    }

    function hideMsg(el) {
      if (!el) return;
      el.style.display = 'none';
    }

    // ===== 1. ç®¡ç†å‘˜ç™»å½• =====
    async function loginAdmin() {
      const emailInput = document.getElementById('adminEmail');
      const pwdInput = document.getElementById('adminPassword');
      const msg = document.getElementById('loginMsg');
      const btn = document.getElementById('loginBtn');

      hideMsg(msg);
      btn.disabled = true;
      btn.textContent = 'ç™»å½•ä¸­...';

      try {
        const res = await fetch(API_BASE + '/admin/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: emailInput.value.trim(),
            password: pwdInput.value
          })
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (e) {
          console.error('login parse error', text);
          throw new Error('åå°è¿”å›çš„ä¸æ˜¯ JSON: ' + text.slice(0, 120));
        }

        if (!res.ok || !data.token) {
          showMsg(msg, 'error', data.error || 'ç™»å½•å¤±è´¥');
          btn.disabled = false;
          btn.textContent = 'ç™»å…¥åå°';
          return;
        }

        setAdminToken(data.token);
        showMsg(msg, 'success', 'ç™»å½•æˆåŠŸï¼Œå¯ä»¥åœ¨ä¸‹é¢æœç´¢å®¢æˆ·äº†ã€‚');
      } catch (err) {
        console.error(err);
        showMsg(msg, 'error', 'ç™»å½•å¤±è´¥: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ç™»å…¥åå°';
      }
    }

    // ===== 2. æœç´¢å®¢æˆ· + æ˜¾ç¤ºè®¡åˆ’ =====
    async function searchUser() {
      const email = document.getElementById('customerEmail').value.trim().toLowerCase();
      const msg = document.getElementById('searchUserMsg');
      hideMsg(msg);

      if (!email || !email.includes('@')) {
        showMsg(msg, 'error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å®¢æˆ·é‚®ç®±ã€‚');
        return;
      }

      const noUserHint = document.getElementById('noUserHint');
      const detailArea = document.getElementById('userDetailArea');
      const currentChip = document.getElementById('currentUserChip');
      const currentEmailSpan = document.getElementById('currentUserEmail');

      try {
        const res = await authFetch(`/admin/api/search-user?email=${encodeURIComponent(email)}`, {
          method: 'GET'
        });
        const data = await res.json();

        if (!data.user) {
          currentUserEmail = null;
          currentChip.style.display = 'none';
          detailArea.style.display = 'none';
          noUserHint.style.display = 'block';
          showMsg(msg, 'error', 'æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªé‚®ç®±å¯¹åº”çš„ç”¨æˆ·ã€‚');
          return;
        }

        currentUserEmail = data.user.email;
        currentEmailSpan.textContent = data.user.email;
        currentChip.style.display = 'inline-flex';
        noUserHint.style.display = 'none';
        detailArea.style.display = 'block';

        const p = data.plans || {};
        document.getElementById('planBarking').checked = !!p.plan_barking;
        document.getElementById('planLeash').checked = !!p.plan_leash;
        document.getElementById('planPuppy').checked = !!p.plan_puppy;
        document.getElementById('planBundle').checked = !!p.plan_bundle;

        showMsg(msg, 'success', 'å·²åŠ è½½å®¢æˆ·ä¿¡æ¯ï¼Œå¯ä»¥è°ƒæ•´è®­ç»ƒè®¡åˆ’ã€‚');
      } catch (err) {
        console.error(err);
        showMsg(msg, 'error', 'è¯·æ±‚å¤±è´¥: ' + err.message);
      }
    }

    async function savePlans() {
      if (!currentUserEmail) {
        const msg = document.getElementById('savePlansMsg');
        showMsg(msg, 'error', 'è¯·å…ˆåœ¨å·¦ä¾§æœç´¢å¹¶é€‰æ‹©ä¸€ä¸ªå®¢æˆ·ã€‚');
        return;
      }

      const msg = document.getElementById('savePlansMsg');
      hideMsg(msg);

      const plan_barking = document.getElementById('planBarking').checked;
      const plan_leash = document.getElementById('planLeash').checked;
      const plan_puppy = document.getElementById('planPuppy').checked;
      const plan_bundle = document.getElementById('planBundle').checked;

      try {
        const res = await authFetch('/admin/api/update-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail,
            plan_barking,
            plan_leash,
            plan_puppy,
            plan_bundle
          })
        });

        const data = await res.json();
        if (!res.ok || !data.success) {
          showMsg(msg, 'error', data.error || 'ä¿å­˜å¤±è´¥');
          return;
        }
        showMsg(msg, 'success', 'è®­ç»ƒè®¡åˆ’å·²ä¿å­˜ã€‚');
      } catch (err) {
        console.error(err);
        showMsg(msg, 'error', 'ä¿å­˜å¤±è´¥: ' + err.message);
      }
    }

    // ===== 3. è®¢å•åˆ—è¡¨ =====
    async function loadOrders() {
      const tbody = document.getElementById('ordersTbody');
      if (!tbody) return;

      tbody.innerHTML = '<tr><td colspan="6" class="muted">åŠ è½½ä¸­...</td></tr>';

      try {
        const res = await authFetch('/admin/api/orders?limit=50', { method: 'GET' });
        const data = await res.json();
        const orders = data.orders || [];

        if (!orders.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="muted">æš‚æ— æ•°æ®</td></tr>';
          return;
        }

        tbody.innerHTML = orders.map((o, idx) => {
          const amount = o.amount_cents != null ? (o.amount_cents / 100).toFixed(2) : '-';
          return `<tr>
            <td>${idx + 1}</td>
            <td>${o.created_at || ''}</td>
            <td>${o.email || ''}</td>
            <td>${o.product_code || ''}</td>
            <td>${amount}</td>
            <td>${o.source || ''}</td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="6" class="muted">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
      }
    }

    // ===== 4. ç»Ÿè®¡ + æœ€è¿‘ç”¨æˆ· =====
    async function loadStatsAndUsers() {
      const usersEl = document.getElementById('statUsersTotal');
      const ordersEl = document.getElementById('statOrdersTotal');
      const revTotalEl = document.getElementById('statRevenueTotal');
      const rev7dEl = document.getElementById('statRevenue7d');
      const usersTbody = document.getElementById('recentUsersTbody');

      if (usersTbody) {
        usersTbody.innerHTML = '<tr><td colspan="2" class="muted">åŠ è½½ä¸­...</td></tr>';
      }

      try {
        const res = await authFetch('/admin/api/stats', { method: 'GET' });
        const data = await res.json();

        const usersTotal = data.users_total ?? 0;
        const ordersTotal = data.orders_total ?? 0;
        const revenueTotal = (data.revenue_total_cents ?? 0) / 100;
        const revenue7d = (data.revenue_7d_cents ?? 0) / 100;

        if (usersEl) usersEl.textContent = String(usersTotal);
        if (ordersEl) ordersEl.textContent = String(ordersTotal);
        if (revTotalEl) revTotalEl.textContent = revenueTotal.toFixed(2);
        if (rev7dEl) rev7dEl.textContent = revenue7d.toFixed(2);

        // æœ€è¿‘ç”¨æˆ·
        const recentUsers = data.recent_users || [];
        if (!recentUsers.length) {
          usersTbody.innerHTML = '<tr><td colspan="2" class="muted">æš‚æ— ç”¨æˆ·</td></tr>';
        } else {
          usersTbody.innerHTML = recentUsers.map(u => `
            <tr>
              <td>${u.id}</td>
              <td>${u.email}</td>
            </tr>
          `).join('');
        }

        // äº§å“æ”¶å…¥å›¾è¡¨
        const byProduct = data.by_product || [];
        const labels = byProduct.map(p => p.product_code || 'æœªçŸ¥');
        const values = byProduct.map(p => (p.sum_cents || 0) / 100);

        const ctx = document.getElementById('revenueChart').getContext('2d');
        if (revenueChart) revenueChart.destroy();
        revenueChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'æŒ‰äº§å“ç´¯è®¡æ”¶å…¥ï¼ˆUSDï¼‰',
              data: values
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { font: { size: 10 } } },
              y: { beginAtZero: true, ticks: { font: { size: 10 } } }
            }
          }
        });

      } catch (err) {
        console.error(err);
        if (usersTbody) {
          usersTbody.innerHTML = `<tr><td colspan="2" class="muted">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
        }
      }
    }

    // ===== 5. ç®¡ç†å‘˜ & æ—¥å¿— =====
    async function loadAdminsAndLogs() {
      const adminsTbody = document.getElementById('adminsTbody');
      const logsTbody = document.getElementById('logsTbody');

      if (adminsTbody) {
        adminsTbody.innerHTML = '<tr><td colspan="3" class="muted">åŠ è½½ä¸­...</td></tr>';
      }
      if (logsTbody) {
        logsTbody.innerHTML = '<tr><td colspan="4" class="muted">åŠ è½½ä¸­...</td></tr>';
      }

      try {
        // ç®¡ç†å‘˜åˆ—è¡¨
        const resAdmins = await authFetch('/admin/api/admins', { method: 'GET' });
        const dataAdmins = await resAdmins.json();
        const admins = dataAdmins.admins || [];
        if (!admins.length) {
          adminsTbody.innerHTML = '<tr><td colspan="3" class="muted">æš‚æ— ç®¡ç†å‘˜è®°å½•</td></tr>';
        } else {
          adminsTbody.innerHTML = admins.map(a => `
            <tr>
              <td>${a.id}</td>
              <td>${a.email}</td>
              <td>${a.role}</td>
            </tr>
          `).join('');
        }

        // æ—¥å¿—
        const resLogs = await authFetch('/admin/api/logs?limit=50', { method: 'GET' });
        const dataLogs = await resLogs.json();
        const logs = dataLogs.logs || [];
        if (!logs.length) {
          logsTbody.innerHTML = '<tr><td colspan="4" class="muted">æš‚æ— æ—¥å¿—</td></tr>';
        } else {
          logsTbody.innerHTML = logs.map(l => `
            <tr>
              <td>${l.created_at || ''}</td>
              <td>${l.admin_email || ''}</td>
              <td>${l.action || ''}</td>
              <td>${l.target_email || ''}</td>
            </tr>
          `).join('');
        }

      } catch (err) {
        console.error(err);
        adminsTbody.innerHTML = `<tr><td colspan="3" class="muted">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
        logsTbody.innerHTML = `<tr><td colspan="4" class="muted">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
      }
    }

    async function createAdmin() {
      const email = document.getElementById('newAdminEmail').value.trim().toLowerCase();
      const pwd = document.getElementById('newAdminPassword').value;
      const role = document.getElementById('newAdminRole').value;
      const msg = document.getElementById('createAdminMsg');
      hideMsg(msg);

      if (!email || !email.includes('@') || pwd.length < 8) {
        showMsg(msg, 'error', 'è¯·è¾“å…¥æœ‰æ•ˆé‚®ç®±ï¼Œå¯†ç è‡³å°‘ 8 ä½ã€‚');
        return;
      }

      try {
        const res = await authFetch('/admin/api/create-admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password: pwd, role })
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          showMsg(msg, 'error', data.error || 'åˆ›å»ºå¤±è´¥ï¼ˆç¡®è®¤ä½ å½“å‰è´¦å·æ˜¯ superï¼‰');
          return;
        }
        showMsg(msg, 'success', 'åˆ›å»ºæˆåŠŸï¼Œåˆ·æ–°ä¸€ä¸‹ç®¡ç†å‘˜åˆ—è¡¨ã€‚');
        document.getElementById('newAdminEmail').value = '';
        document.getElementById('newAdminPassword').value = '';
        loadAdminsAndLogs();
      } catch (err) {
        console.error(err);
        showMsg(msg, 'error', 'åˆ›å»ºå¤±è´¥: ' + err.message);
      }
    }

    // ===== åˆå§‹åŒ– & äº‹ä»¶ç»‘å®š =====
    document.addEventListener('DOMContentLoaded', () => {
      // è¿˜åŸ token çŠ¶æ€
      getAdminToken();

      document.getElementById('loginBtn').addEventListener('click', loginAdmin);
      document.getElementById('firstLoginBtn').addEventListener('click', () => {
        document.getElementById('adminEmail').value = 'admin@calmpaw.local';
        document.getElementById('adminPassword').value = 'CalmPawAdmin123!';
      });

      document.getElementById('searchUserBtn').addEventListener('click', searchUser);
      document.getElementById('savePlansBtn').addEventListener('click', savePlans);
      document.getElementById('refreshOrdersBtn').addEventListener('click', loadOrders);
      document.getElementById('refreshStatsBtn').addEventListener('click', () => {
        loadStatsAndUsers();
        loadOrders();
      });
      document.getElementById('refreshLogsBtn').addEventListener('click', () => {
        loadAdminsAndLogs();
      });
      document.getElementById('createAdminBtn').addEventListener('click', createAdmin);
    });
  </script>
</body>
</html>
