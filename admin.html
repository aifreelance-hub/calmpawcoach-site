<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw ç®¡ç†å‘˜åå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 12px;
      background: radial-gradient(circle at top, #ffe4c4 0%, #fff7f0 45%, #ffe4c4 100%);
    }
    .shell {
      max-width: 1080px;
      width: 100%;
      background: #fffaf5;
      border-radius: 32px;
      box-shadow: 0 28px 80px rgba(0, 0, 0, 0.08);
      padding: 28px 28px 32px;
      border: 1px solid rgba(248, 180, 116, 0.35);
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-circle {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: conic-gradient(from 210deg, #ffb86b, #ff914d, #ffe5c2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .title-main {
      font-size: 18px;
      font-weight: 700;
      color: #3b2824;
    }
    .title-sub {
      font-size: 12px;
      color: #8a6a63;
    }
    .header-tag {
      padding: 4px 10px;
      border-radius: 999px;
      background: #fff1e0;
      font-size: 11px;
      color: #b45309;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
      gap: 18px;
    }

    .card {
      border-radius: 24px;
      background: #fff;
      padding: 18px 18px 20px;
      border: 1px solid rgba(248, 180, 116, 0.36);
      box-shadow: 0 16px 40px rgba(248, 180, 116, 0.08);
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #3b2824;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-desc {
      font-size: 12px;
      color: #8a6a63;
      margin-bottom: 14px;
      line-height: 1.5;
    }

    label {
      display: block;
      font-size: 12px;
      color: #6b4c45;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #f3d9c4;
      padding: 9px 12px;
      font-size: 13px;
      outline: none;
      background: #fffaf5;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    input:focus {
      border-color: #ff914d;
      box-shadow: 0 0 0 1px rgba(255, 145, 77, 0.3);
      background: #fff;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #ffb86b, #ff914d);
      color: #3b2824;
      box-shadow: 0 12px 28px rgba(255, 145, 77, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(255, 145, 77, 0.45);
      filter: brightness(0.97);
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .muted {
      font-size: 11px;
      color: #a78b7c;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #fef3c7;
      color: #92400e;
      gap: 3px;
    }

    .msg {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: none;
    }
    .msg.info {
      background: #fef9c3;
      color: #854d0e;
      border: 1px solid #facc15;
    }
    .msg.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .msg.success {
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .field-row {
      margin-bottom: 12px;
    }

    .plans-box {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    .plan-tag {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #f3d9c4;
      font-size: 12px;
      background: #fffaf5;
      cursor: pointer;
    }
    .plan-tag span {
      font-size: 11px;
      color: #8a6a63;
    }
    .plan-tag input {
      width: 14px;
      height: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3d9c4;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: #6b4c45;
      background: #fff3e0;
    }
    tbody tr:nth-child(even) td {
      background: #fffaf5;
    }
    .ellipsis {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    @media (max-width: 880px) {
      .shell { padding: 20px 16px 24px; }
      .grid { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="header-left">
        <div class="logo-circle">ğŸ¾</div>
        <div>
          <div class="title-main">CalmPaw ç®¡ç†å‘˜</div>
          <div class="title-sub">ç»™å®¢æˆ·å¼€è®­ç»ƒè®¡åˆ’ / è¡¥å• / æŸ¥çœ‹è®¢å•è®°å½•</div>
        </div>
      </div>
      <div class="header-tag" id="adminStatus">æœªç™»å½•</div>
    </div>

    <div class="grid">
      <!-- å·¦ä¾§ï¼šç™»å½• + æœç´¢ -->
      <div>
        <div class="card" style="margin-bottom: 14px;">
          <div class="card-title">
            1. ç®¡ç†å‘˜ç™»å½•
            <span class="badge">
              é¦–æ¬¡ç™»å½•è´¦å·
            </span>
          </div>
          <div class="card-desc">
            ç¬¬ä¸€æ¬¡ä½¿ç”¨è¯·å…ˆç”¨é»˜è®¤è´¦å·ç™»å½•ï¼š<br>
            <code style="font-size:11px;color:#b45309;">admin@calmpaw.local / CalmPawAdmin123!</code><br>
            ç™»å½•æˆåŠŸåå¯ä»¥åœ¨æ•°æ®åº“é‡Œæ”¹æˆä½ è‡ªå·±çš„é‚®ç®±å’Œå¯†ç ã€‚
          </div>

          <div class="field-row">
            <label>ç®¡ç†å‘˜é‚®ç®±</label>
            <input id="adminEmail" type="email" value="admin@calmpaw.local" />
          </div>
          <div class="field-row">
            <label>å¯†ç </label>
            <input id="adminPassword" type="password" />
          </div>
          <button id="loginBtn">ç™»å…¥åå°</button>

          <div id="loginMsg" class="msg info"></div>
        </div>

        <div class="card">
          <div class="card-title">2. æœç´¢å®¢æˆ·é‚®ç®±</div>
          <div class="card-desc">
            å…ˆç™»å½•åå°ï¼Œå†åœ¨è¿™é‡Œè¾“å…¥å®¢æˆ·é‚®ç®±ï¼ŒæŸ¥çœ‹å¹¶ä¿®æ”¹ä»–ä»¬çš„è®­ç»ƒè®¡åˆ’ / æ‰‹åŠ¨è¡¥å•ã€‚
          </div>
          <div class="field-row">
            <label>å®¢æˆ·é‚®ç®±</label>
            <input id="searchEmail" type="email" placeholder="customer@example.com" />
          </div>
          <button id="searchBtn">æœç´¢å®¢æˆ·</button>
          <div id="searchMsg" class="msg info"></div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå®¢æˆ·ä¿¡æ¯ + è®¢å• -->
      <div style="display:flex; flex-direction:column; gap:14px;">
        <div class="card" style="flex:1;">
          <div class="card-title">3. å®¢æˆ·ä¿¡æ¯ & è®­ç»ƒè®¡åˆ’</div>
          <div class="card-desc" id="userSummary">
            è¿˜æ²¡æœ‰é€‰æ‹©å®¢æˆ·ã€‚åœ¨å·¦ä¾§è¾“å…¥å®¢æˆ·é‚®ç®±å¹¶ç‚¹å‡»ã€Œæœç´¢å®¢æˆ·ã€ã€‚
          </div>

          <div id="userDetailArea" style="display:none; margin-top:8px;">
            <div class="field-row">
              <div class="muted" id="userExtra"></div>
            </div>
            <div class="field-row">
              <label>è®­ç»ƒè®¡åˆ’å¼€é€š / å…³é—­</label>
              <div class="plans-box">
                <label class="plan-tag">
                  <span>é˜²å è®­ç»ƒ (barking)</span>
                  <input type="checkbox" id="plan_barking" />
                </label>
                <label class="plan-tag">
                  <span>ç‰µå¼•è®­ç»ƒ (leash)</span>
                  <input type="checkbox" id="plan_leash" />
                </label>
                <label class="plan-tag">
                  <span>å¹¼çŠ¬ç¤¼ä»ª (puppy)</span>
                  <input type="checkbox" id="plan_puppy" />
                </label>
                <label class="plan-tag">
                  <span>å…¨å¥— Bundle</span>
                  <input type="checkbox" id="plan_bundle" />
                </label>
              </div>
            </div>
            <button id="savePlansBtn">ä¿å­˜è®¡åˆ’</button>
            <div id="plansMsg" class="msg info"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            4. æœ€è¿‘è®¢å•ï¼ˆå¯é€‰ï¼‰
            <button id="refreshOrdersBtn" style="font-size:11px;padding:6px 10px;">åˆ·æ–°è®¢å•åˆ—è¡¨</button>
          </div>
          <div class="card-desc">
            è¿™é‡Œä¼šå±•ç¤º `orders` è¡¨æœ€è¿‘ 20 æ¡è®°å½•ï¼Œæ–¹ä¾¿ä½ å¿«é€ŸæŸ¥çœ‹æŸä¸ªé‚®ç®±éƒ½ä¹°äº†ä»€ä¹ˆäº§å“ã€é‡‘é¢æ˜¯å¤šå°‘ã€‚
          </div>
          <div style="max-height:220px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>æ—¶é—´</th>
                  <th>é‚®ç®±</th>
                  <th>äº§å“</th>
                  <th>é‡‘é¢</th>
                  <th>æ¥æº</th>
                </tr>
              </thead>
              <tbody id="ordersBody">
                <tr><td colspan="6" class="muted">æš‚æ— æ•°æ®</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  //  API åœ°å€ï¼ˆé‡è¦ï¼‰
  // =========================
  // çº¿ä¸Šä½¿ç”¨ä½ çš„ Workerï¼š
  const API_BASE = "https://calmpaw-auth.sophieinbg.workers.dev";

  // æœ¬åœ°å¼€å‘ï¼ˆå¦‚æœæœ‰ï¼‰å¯ä»¥æ”¹æˆ 127.0.0.1:8787
  // const API_BASE = window.location.hostname === "localhost"
  //   ? "http://127.0.0.1:8787"
  //   : "https://calmpaw-auth.sophieinbg.workers.dev";

  // =========================
  //  DOM
  // =========================
  const adminStatus = document.getElementById("adminStatus");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const adminEmailInput = document.getElementById("adminEmail");
  const adminPasswordInput = document.getElementById("adminPassword");

  const searchEmailInput = document.getElementById("searchEmail");
  const searchBtn = document.getElementById("searchBtn");
  const searchMsg = document.getElementById("searchMsg");

  const userSummary = document.getElementById("userSummary");
  const userDetailArea = document.getElementById("userDetailArea");
  const userExtra = document.getElementById("userExtra");
  const plansMsg = document.getElementById("plansMsg");
  const savePlansBtn = document.getElementById("savePlansBtn");

  const plan_barking = document.getElementById("plan_barking");
  const plan_leash = document.getElementById("plan_leash");
  const plan_puppy = document.getElementById("plan_puppy");
  const plan_bundle = document.getElementById("plan_bundle");

  const refreshOrdersBtn = document.getElementById("refreshOrdersBtn");
  const ordersBody = document.getElementById("ordersBody");

  let currentUserEmail = null;

  function getAdminToken() {
    return localStorage.getItem("calmpaw_admin_token") || "";
  }

  function setAdminToken(token) {
    if (token) {
      localStorage.setItem("calmpaw_admin_token", token);
    } else {
      localStorage.removeItem("calmpaw_admin_token");
    }
  }

  function setMsg(el, type, text) {
    if (!text) {
      el.style.display = "none";
      return;
    }
    el.className = "msg " + type;
    el.textContent = text;
    el.style.display = "block";
  }

  function updateAdminStatus() {
    const token = getAdminToken();
    if (token) {
      adminStatus.textContent = "å·²ç™»å½•";
      adminStatus.style.background = "#dcfce7";
      adminStatus.style.color = "#166534";
    } else {
      adminStatus.textContent = "æœªç™»å½•";
      adminStatus.style.background = "#fff1e0";
      adminStatus.style.color = "#b45309";
    }
  }

  updateAdminStatus();

  // é€šç”¨å¸¦ token çš„ fetch
  async function adminFetch(path, options = {}) {
    const token = getAdminToken();
    const headers = Object.assign(
      {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      options.headers || {}
    );
    if (token) {
      headers["Authorization"] = "Bearer " + token;
    }
    const res = await fetch(API_BASE + path, Object.assign({}, options, { headers }));
    const text = await res.text();

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("åå°è¿”å›çš„ä¸æ˜¯ JSON:", text);
      throw new Error("åå°è¿”å›çš„ä¸æ˜¯ JSON: " + text.slice(0, 120));
    }

    if (!res.ok) {
      const errMsg = data.error || ("HTTP " + res.status);
      throw new Error(errMsg);
    }
    return data;
  }

  // =========================
  //  ç™»å½•
  // =========================
  loginBtn.addEventListener("click", async () => {
    const email = adminEmailInput.value.trim();
    const password = adminPasswordInput.value;
    if (!email || !password) {
      setMsg(loginMsg, "error", "é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºã€‚");
      return;
    }

    loginBtn.disabled = true;
    setMsg(loginMsg, "info", "æ­£åœ¨ç™»å½•åå°â€¦");

    try {
      const res = await fetch(API_BASE + "/admin/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error("login parse error:", text);
        throw new Error("åå°è¿”å›çš„ä¸æ˜¯ JSON: " + text.slice(0, 120));
      }

      if (!res.ok) {
        throw new Error(data.error || "ç™»å½•å¤±è´¥");
      }
      if (!data.token) {
        throw new Error("æœªæ”¶åˆ° token");
      }

      setAdminToken(data.token);
      updateAdminStatus();
      setMsg(loginMsg, "success", "ç™»å½•æˆåŠŸã€‚å¯ä»¥åœ¨ä¸‹é¢æœç´¢å®¢æˆ·äº†ã€‚");
    } catch (err) {
      console.error(err);
      setAdminToken("");
      updateAdminStatus();
      setMsg(loginMsg, "error", "ç™»å½•å¤±è´¥ï¼š" + err.message);
    } finally {
      loginBtn.disabled = false;
    }
  });

  // =========================
  //  æœç´¢å®¢æˆ·
  // =========================
  searchBtn.addEventListener("click", async () => {
    const email = searchEmailInput.value.trim().toLowerCase();
    if (!email) {
      setMsg(searchMsg, "error", "è¯·è¾“å…¥å®¢æˆ·é‚®ç®±ã€‚");
      return;
    }
    setMsg(searchMsg, "info", "æ­£åœ¨æœç´¢å®¢æˆ·â€¦");
    userDetailArea.style.display = "none";
    currentUserEmail = null;

    try {
      const data = await adminFetch("/admin/api/search-user?email=" + encodeURIComponent(email), {
        method: "GET"
      });

      if (!data.user) {
        userSummary.textContent = "æ²¡æœ‰æ‰¾åˆ°è¯¥é‚®ç®±çš„å®¢æˆ·ã€‚";
        setMsg(searchMsg, "info", "ä½ å¯ä»¥é€šè¿‡ã€Œåˆ›å»ºç”¨æˆ·ã€åŠŸèƒ½åœ¨åç»­ç‰ˆæœ¬é‡Œè¡¥å•ï¼ˆç°åœ¨å…ˆæ‰‹åŠ¨åœ¨å‰ç«¯æ³¨å†Œï¼‰ã€‚");
        return;
      }

      currentUserEmail = data.user.email;
      userSummary.textContent = "å½“å‰å®¢æˆ·ï¼š" + data.user.email + "ï¼ˆid: " + data.user.id + "ï¼‰";
      userExtra.textContent = "å¯ä»¥å‹¾é€‰ä¸‹é¢çš„è®­ç»ƒè®¡åˆ’ä¸ºä»–å¼€é€š / å…³é—­è®¿é—®æƒé™ã€‚";

      const plans = data.plans || {};
      plan_barking.checked = !!plans.plan_barking;
      plan_leash.checked = !!plans.plan_leash;
      plan_puppy.checked = !!plans.plan_puppy;
      plan_bundle.checked = !!plans.plan_bundle;

      userDetailArea.style.display = "block";
      setMsg(searchMsg, "success", "å·²åŠ è½½å®¢æˆ·ä¿¡æ¯ã€‚");
      setMsg(plansMsg, "info", "è°ƒæ•´å‹¾é€‰åç‚¹å‡»ã€Œä¿å­˜è®¡åˆ’ã€ã€‚");
    } catch (err) {
      console.error(err);
      setMsg(searchMsg, "error", "æœç´¢å¤±è´¥ï¼š" + err.message);
    }
  });

  // =========================
  //  ä¿å­˜è®¡åˆ’
  // =========================
  savePlansBtn.addEventListener("click", async () => {
    if (!currentUserEmail) {
      setMsg(plansMsg, "error", "è¯·å…ˆæœç´¢å®¢æˆ·ã€‚");
      return;
    }
    setMsg(plansMsg, "info", "æ­£åœ¨ä¿å­˜â€¦");
    savePlansBtn.disabled = true;

    try {
      await adminFetch("/admin/api/update-user", {
        method: "POST",
        body: JSON.stringify({
          email: currentUserEmail,
          plan_barking: plan_barking.checked,
          plan_leash: plan_leash.checked,
          plan_puppy: plan_puppy.checked,
          plan_bundle: plan_bundle.checked
        })
      });
      setMsg(plansMsg, "success", "å·²æ›´æ–°è®­ç»ƒè®¡åˆ’ã€‚");
    } catch (err) {
      console.error(err);
      setMsg(plansMsg, "error", "ä¿å­˜å¤±è´¥ï¼š" + err.message);
    } finally {
      savePlansBtn.disabled = false;
    }
  });

  // =========================
  //  è®¢å•åˆ—è¡¨
  // =========================
  async function loadOrders() {
    ordersBody.innerHTML = '<tr><td colspan="6" class="muted">åŠ è½½ä¸­â€¦</td></tr>';
    try {
      const data = await adminFetch("/admin/api/orders?limit=20", { method: "GET" });
      const orders = data.orders || [];
      if (!orders.length) {
        ordersBody.innerHTML = '<tr><td colspan="6" class="muted">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      ordersBody.innerHTML = "";
      orders.forEach((o, idx) => {
        const tr = document.createElement("tr");
        const amount = o.amount_cents != null ? (o.amount_cents / 100).toFixed(2) : "-";
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${o.created_at || "-"}</td>
          <td class="ellipsis" title="${o.email || ""}">${o.email || ""}</td>
          <td>${o.product_code || "-"}</td>
          <td>${amount} ${o.currency || ""}</td>
          <td>${o.source || "-"}</td>
        `;
        ordersBody.appendChild(tr);
      });
    } catch (err) {
      console.error(err);
      ordersBody.innerHTML = '<tr><td colspan="6" class="muted">åŠ è½½å¤±è´¥ï¼š' + err.message + '</td></tr>';
    }
  }

  refreshOrdersBtn.addEventListener("click", loadOrders);

  // å¦‚æœå·²ç»ç™»å½•ï¼Œè‡ªåŠ¨åŠ è½½è®¢å•
  if (getAdminToken()) {
    loadOrders();
  }
</script>
</body>
</html>
