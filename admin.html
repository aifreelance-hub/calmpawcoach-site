<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw ç®¡ç†å‘˜åå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #ffe7cf 0%, #fff7f0 40%, #fffaf5 100%);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px 16px;
      color: #3b2824;
    }
    .shell {
      width: 100%;
      max-width: 1080px;
      background: rgba(255,255,255,0.98);
      border-radius: 26px;
      box-shadow: 0 24px 60px rgba(210,145,96,0.22);
      padding: 24px 24px 28px;
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 24px;
    }
    @media (max-width: 840px) {
      .shell {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(from 200deg, #ffb86b, #ff914d, #ffe0b8);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
    }
    .logo-title {
      font-weight: 700;
      font-size: 18px;
      color: #3b2824;
    }
    .logo-sub {
      font-size: 12px;
      color: #8a6a63;
    }
    h2.section-title {
      font-size: 15px;
      font-weight: 600;
      margin: 12px 0 8px;
      color: #5a3b32;
    }
    .card {
      background: #fff7f0;
      border-radius: 20px;
      border: 1px solid #f3d9c4;
      padding: 16px 16px 18px;
      margin-bottom: 14px;
    }
    label {
      display: block;
      font-size: 12px;
      color: #8a6a63;
      margin-bottom: 4px;
    }
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width: 100%;
      padding: 8px 11px;
      border-radius: 999px;
      border: 1px solid #f3d9c4;
      font-size: 13px;
      outline: none;
      background: #fffdf9;
    }
    input:focus {
      border-color: #ffb86b;
      box-shadow: 0 0 0 1px rgba(255,184,107,0.4);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #ffb86b, #ff914d);
      color: #3b2824;
      box-shadow: 0 10px 25px rgba(255,145,77,0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }
    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(255,145,77,0.4);
    }
    .btn-secondary {
      background: #fff;
      border: 1px solid #f3d9c4;
      box-shadow: none;
      color: #5a3b32;
    }
    .small {
      font-size: 12px;
      color: #a88173;
    }
    .muted {
      color: #b39a92;
      font-size: 11px;
    }
    .msg {
      font-size: 12px;
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      display: none;
    }
    .msg.error {
      color: #b42318;
      background: #fee2e2;
      border: 1px solid #fecaca;
    }
    .msg.success {
      color: #166534;
      background: #dcfce7;
      border: 1px solid #bbf7d0;
    }
    .badge {
      display: inline-flex;
      padding: 0 8px;
      border-radius: 999px;
      background: #fef3c7;
      color: #b45309;
      font-size: 10px;
      align-items: center;
      gap: 4px;
    }
    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      margin: 8px 0 2px;
    }
    .checkbox-row label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      margin-bottom: 0;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3d9c4;
      text-align: left;
      vertical-align: top;
    }
    th {
      color: #8a6a63;
      font-weight: 500;
      background: #fff4e5;
    }
    tbody tr:nth-child(even) td {
      background: #fffaf3;
    }
    .pill {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ecfdf3;
      font-size: 11px;
      color: #166534;
    }
    .pill.red {
      background: #fee2e2;
      color: #b42318;
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- å·¦è¾¹ï¼šç™»å½• + æœç´¢ç”¨æˆ· -->
    <div>
      <div class="logo-row">
        <div class="logo-icon">ğŸ¾</div>
        <div>
          <div class="logo-title">CalmPaw ç®¡ç†å‘˜</div>
          <div class="logo-sub">ç»™å®¢æˆ·å¼€è®­ç»ƒè®¡åˆ’ / è¡¥å• / æŸ¥çœ‹è®¢å•</div>
        </div>
      </div>

      <div class="card">
        <h2 class="section-title">1. ç®¡ç†å‘˜ç™»å½•</h2>
        <p class="small" style="margin-bottom:10px;">
          é¦–æ¬¡ç™»å½•è¯·ä½¿ç”¨é»˜è®¤è´¦å·ï¼ˆç™»é™†æˆåŠŸåå¯ä»¥åœ¨æ•°æ®åº“é‡Œæ”¹é‚®ç®±å’Œå¯†ç ï¼‰ï¼š<br>
          <span class="badge">admin@calmpaw.local / CalmPawAdmin123!</span>
        </p>

        <label for="admin-email">ç®¡ç†å‘˜é‚®ç®±</label>
        <input id="admin-email" type="email" autocomplete="username" placeholder="admin@calmpaw.local" />

        <label for="admin-password" style="margin-top:8px;">å¯†ç </label>
        <input id="admin-password" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />

        <button id="login-btn" style="margin-top:12px; width:100%;">ç™»å…¥åå°</button>
        <div id="login-msg" class="msg"></div>
      </div>

      <div class="card">
        <h2 class="section-title">2. æœç´¢å®¢æˆ·é‚®ç®±</h2>
        <p class="muted" style="margin-bottom:6px;">å¿…é¡»å…ˆç™»å½•åå°ï¼Œæ‰èƒ½æœç´¢å’Œä¿®æ”¹å®¢æˆ·è®¡åˆ’ã€‚</p>
        <label for="search-email">å®¢æˆ·é‚®ç®±</label>
        <input id="search-email" type="email" placeholder="customer@example.com" />
        <button id="search-btn" style="margin-top:10px; width:100%;">æœç´¢å®¢æˆ·</button>
        <div id="search-msg" class="msg"></div>
      </div>
    </div>

    <!-- å³è¾¹ï¼šå®¢æˆ·è¯¦æƒ… + è®¡åˆ’ -->
    <div>
      <div class="card" id="user-card" style="min-height:180px;">
        <h2 class="section-title">3. å®¢æˆ·ä¿¡æ¯ &amp; è®­ç»ƒè®¡åˆ’</h2>
        <div id="user-empty" class="muted">
          è¿˜æ²¡æœ‰é€‰ä¸­å®¢æˆ·ã€‚å·¦ä¾§è¾“å…¥å®¢æˆ·é‚®ç®±ï¼Œç‚¹å‡»ã€Œæœç´¢å®¢æˆ·ã€ã€‚
        </div>
        <div id="user-info" style="display:none;">
          <div class="small" style="margin-bottom:6px;">
            å®¢æˆ·é‚®ç®±ï¼š<span id="user-email" style="font-weight:600;"></span>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" id="plan-barking"> Barking è®¡åˆ’ï¼ˆ$19ï¼‰</label>
            <label><input type="checkbox" id="plan-leash"> Leash è®¡åˆ’ï¼ˆ$29ï¼‰</label>
            <label><input type="checkbox" id="plan-puppy"> Puppy è®¡åˆ’ï¼ˆ$19ï¼‰</label>
            <label><input type="checkbox" id="plan-bundle"> ä¸‰åˆä¸€ Bundleï¼ˆ$49ï¼‰</label>
          </div>
          <div class="muted" style="margin-top:2px;">
            å‹¾é€‰ = æœ‰æƒé™è®¿é—®å¯¹åº”é¡µé¢ï¼›å–æ¶ˆ = æ”¶å›è®¿é—®æƒé™ï¼ˆä¸ä¼šåˆ é™¤è´¦å·ï¼‰ã€‚
          </div>
          <button id="save-plans-btn" style="margin-top:10px;">ä¿å­˜ä¿®æ”¹</button>
          <button id="reload-btn" class="btn-secondary" style="margin-top:10px; margin-left:6px;">é‡æ–°æ‹‰å–</button>
          <div id="plans-msg" class="msg"></div>
        </div>
      </div>

      <div class="card">
        <h2 class="section-title">4. æœ€è¿‘è®¢å•ï¼ˆå¯é€‰ï¼‰</h2>
        <p class="muted" style="margin-bottom:6px;">
          è¿™é‡Œåªç®€å•å±•ç¤º orders è¡¨æœ€è¿‘ 20 æ¡è®°å½•ï¼Œä¸»è¦æ–¹ä¾¿ä½ æ ¸å¯¹é‡‘é¢å’Œäº§å“ä»£ç ã€‚
        </p>
        <button id="load-orders-btn" class="btn-secondary" style="margin-bottom:8px;">åˆ·æ–°è®¢å•åˆ—è¡¨</button>
        <div style="max-height:220px; overflow:auto; border-radius:14px; border:1px solid #f3d9c4; background:#fff;">
          <table id="orders-table">
            <thead>
              <tr>
                <th>#</th>
                <th>æ—¶é—´</th>
                <th>é‚®ç®±</th>
                <th>äº§å“</th>
                <th>é‡‘é¢</th>
                <th>æ¥æº</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="6" class="muted" style="padding:10px;">æš‚æ— æ•°æ®</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== åç«¯ API æ ¹è·¯å¾„ï¼šèµ° Cloudflare Worker /w/auth =====
    const API_BASE = 'https://calmpawcoach.com/w/auth';

    // localStorage key
    const ADMIN_TOKEN_KEY = 'calmpaw_admin_token';

    function setAdminToken(token) {
      if (!token) {
        localStorage.removeItem(ADMIN_TOKEN_KEY);
      } else {
        localStorage.setItem(ADMIN_TOKEN_KEY, token);
      }
    }
    function getAdminToken() {
      return localStorage.getItem(ADMIN_TOKEN_KEY) || '';
    }

    function showMsg(el, type, text) {
      el.style.display = 'block';
      el.className = 'msg ' + (type === 'error' ? 'error' : 'success');
      el.textContent = text;
    }
    function hideMsg(el) {
      el.style.display = 'none';
    }

    // é€šç”¨å¸¦ç®¡ç†å‘˜ token çš„è¯·æ±‚
    async function adminFetch(path, options = {}) {
      const token = getAdminToken();
      const headers = Object.assign(
        { 'Content-Type': 'application/json' },
        (options.headers || {})
      );
      if (token) {
        headers['Authorization'] = 'Bearer ' + token;
      }
      const res = await fetch(API_BASE + path, {
        method: options.method || 'GET',
        headers,
        body: options.body ? JSON.stringify(options.body) : undefined,
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error('åå°è¿”å›çš„ä¸æ˜¯ JSONï¼š', text);
        throw new Error('åå°è¿”å›çš„ä¸æ˜¯ JSONï¼š' + text.slice(0, 120));
      }
      if (!res.ok) {
        const errMsg = data.error || ('è¯·æ±‚å¤±è´¥ï¼šHTTP ' + res.status);
        throw new Error(errMsg);
      }
      return data;
    }

    // ===== 1. ç®¡ç†å‘˜ç™»å½• =====
    const loginBtn = document.getElementById('login-btn');
    const loginMsg = document.getElementById('login-msg');
    const adminEmailInput = document.getElementById('admin-email');
    const adminPwdInput = document.getElementById('admin-password');

    loginBtn.addEventListener('click', async () => {
      hideMsg(loginMsg);
      const email = adminEmailInput.value.trim().toLowerCase();
      const password = adminPwdInput.value;

      if (!email || !password) {
        showMsg(loginMsg, 'error', 'è¯·è¾“å…¥ç®¡ç†å‘˜é‚®ç®±å’Œå¯†ç ');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'ç™»å½•ä¸­...';

      try {
        const res = await fetch(API_BASE + '/admin/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('login parse error:', text);
          throw new Error('åå°è¿”å›çš„ä¸æ˜¯ JSONï¼š' + text.slice(0, 120));
        }
        if (!res.ok || !data.token) {
          throw new Error(data.error || 'ç™»å½•å¤±è´¥');
        }

        setAdminToken(data.token);
        showMsg(loginMsg, 'success', 'ç™»å½•æˆåŠŸã€‚ä½ ç°åœ¨å¯ä»¥æœç´¢å®¢æˆ·å¹¶ä¿®æ”¹è®¡åˆ’ã€‚');
      } catch (err) {
        console.error(err);
        showMsg(loginMsg, 'error', err.message || 'ç™»å½•å¤±è´¥');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å…¥åå°';
      }
    });

    // ===== 2. æœç´¢å®¢æˆ· =====
    const searchBtn = document.getElementById('search-btn');
    const searchEmailInput = document.getElementById('search-email');
    const searchMsg = document.getElementById('search-msg');

    const userEmpty = document.getElementById('user-empty');
    const userInfo = document.getElementById('user-info');
    const userEmailSpan = document.getElementById('user-email');

    const planBarking = document.getElementById('plan-barking');
    const planLeash = document.getElementById('plan-leash');
    const planPuppy = document.getElementById('plan-puppy');
    const planBundle = document.getElementById('plan-bundle');

    let currentUserEmail = null;

    function fillPlans(plans) {
      planBarking.checked = !!plans.plan_barking;
      planLeash.checked = !!plans.plan_leash;
      planPuppy.checked = !!plans.plan_puppy;
      planBundle.checked = !!plans.plan_bundle;
    }

    async function loadUserByEmail(email) {
      hideMsg(searchMsg);
      const trimmed = email.trim().toLowerCase();
      if (!trimmed) {
        showMsg(searchMsg, 'error', 'è¯·è¾“å…¥å®¢æˆ·é‚®ç®±');
        return;
      }
      searchBtn.disabled = true;
      searchBtn.textContent = 'æœç´¢ä¸­...';

      try {
        const data = await adminFetch('/admin/api/search-user?email=' + encodeURIComponent(trimmed));
        if (!data.user) {
          currentUserEmail = null;
          userEmpty.style.display = 'block';
          userInfo.style.display = 'none';
          showMsg(searchMsg, 'error', 'æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªé‚®ç®±çš„ç”¨æˆ·');
          return;
        }
        currentUserEmail = data.user.email;
        userEmailSpan.textContent = currentUserEmail;
        fillPlans(data.plans || {});
        userEmpty.style.display = 'none';
        userInfo.style.display = 'block';
        showMsg(searchMsg, 'success', 'å·²åŠ è½½å®¢æˆ·ä¿¡æ¯ï¼Œå¯ä»¥å‹¾é€‰/å–æ¶ˆè®­ç»ƒè®¡åˆ’ã€‚');
      } catch (err) {
        console.error(err);
        showMsg(searchMsg, 'error', err.message || 'æœç´¢å¤±è´¥');
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'æœç´¢å®¢æˆ·';
      }
    }

    searchBtn.addEventListener('click', () => {
      loadUserByEmail(searchEmailInput.value);
    });

    // ===== 3. ä¿å­˜è®­ç»ƒè®¡åˆ’ =====
    const savePlansBtn = document.getElementById('save-plans-btn');
    const reloadBtn = document.getElementById('reload-btn');
    const plansMsg = document.getElementById('plans-msg');

    savePlansBtn.addEventListener('click', async () => {
      hideMsg(plansMsg);
      if (!currentUserEmail) {
        showMsg(plansMsg, 'error', 'è¯·å…ˆæœç´¢å¹¶é€‰ä¸­ä¸€ä¸ªå®¢æˆ·');
        return;
      }

      savePlansBtn.disabled = true;
      savePlansBtn.textContent = 'ä¿å­˜ä¸­...';

      try {
        await adminFetch('/admin/api/update-user', {
          method: 'POST',
          body: {
            email: currentUserEmail,
            plan_barking: planBarking.checked,
            plan_leash: planLeash.checked,
            plan_puppy: planPuppy.checked,
            plan_bundle: planBundle.checked,
          },
        });
        showMsg(plansMsg, 'success', 'å·²ä¿å­˜å®¢æˆ·è®­ç»ƒè®¡åˆ’ã€‚');
      } catch (err) {
        console.error(err);
        showMsg(plansMsg, 'error', err.message || 'ä¿å­˜å¤±è´¥');
      } finally {
        savePlansBtn.disabled = false;
        savePlansBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
      }
    });

    reloadBtn.addEventListener('click', () => {
      if (currentUserEmail) {
        loadUserByEmail(currentUserEmail);
      }
    });

    // ===== 4. è®¢å•åˆ—è¡¨ =====
    const ordersBtn = document.getElementById('load-orders-btn');
    const ordersTableBody = document.querySelector('#orders-table tbody');

    async function loadOrders() {
      ordersBtn.disabled = true;
      ordersBtn.textContent = 'åˆ·æ–°ä¸­...';
      try {
        const data = await adminFetch('/admin/api/orders?limit=20');
        const orders = data.orders || [];
        if (!orders.length) {
          ordersTableBody.innerHTML =
            '<tr><td colspan="6" class="muted" style="padding:10px;">æš‚æ— è®¢å•è®°å½•</td></tr>';
          return;
        }
        ordersTableBody.innerHTML = '';
        orders.forEach((o, idx) => {
          const tr = document.createElement('tr');
          const amount =
            (o.amount_cents != null ? (o.amount_cents / 100).toFixed(2) : '-') +
            ' ' +
            (o.currency || 'USD');
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${o.created_at || '-'}</td>
            <td>${o.email || '-'}</td>
            <td>${o.product_code || '-'}</td>
            <td>${amount}</td>
            <td>${o.source || ''}</td>
          `;
          ordersTableBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        ordersTableBody.innerHTML =
          '<tr><td colspan="6" class="muted" style="padding:10px;">åŠ è½½å¤±è´¥ï¼š' +
          (err.message || 'error') +
          '</td></tr>';
      } finally {
        ordersBtn.disabled = false;
        ordersBtn.textContent = 'åˆ·æ–°è®¢å•åˆ—è¡¨';
      }
    }

    ordersBtn.addEventListener('click', loadOrders);

    // é¡µé¢æ‰“å¼€æ—¶ï¼Œå¦‚æœæœ¬åœ°å·²ç»æœ‰ tokenï¼Œå¯ä»¥å°è¯•åŠ è½½è®¢å•ä¸€æ¬¡
    if (getAdminToken()) {
      loadOrders().catch(() => {});
    }
  </script>
</body>
</html>
