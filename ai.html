<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw Coach ‚Äî Infinite AI Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #fff7f0;
      --bg-soft: #ffeede;
      --accent: #ffb86b;
      --accent-strong: #ff914d;
      --accent-soft: #ffe0b8;
      --text-main: #3b2824;
      --text-soft: #8a6a63;
      --border-soft: #f3d9c4;
      --radius-lg: 26px;
      --radius-md: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 26px 60px rgba(210, 145, 110, 0.38);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        system-ui, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 5% 0%, #ffe0c0 0%, transparent 55%),
        radial-gradient(circle at 100% 0%, #ffd4d4 0%, transparent 55%),
        radial-gradient(circle at 0% 100%, #ffe5c3 0%, transparent 55%),
        linear-gradient(180deg, #fff7f0 0%, #fff2e7 40%, #fff8f2 100%);
      color: var(--text-main);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Header */

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(22px);
      background: linear-gradient(
        to bottom,
        rgba(255, 248, 240, 0.98),
        rgba(255, 248, 240, 0.88),
        rgba(255, 248, 240, 0.75)
      );
      border-bottom: 1px solid rgba(243, 217, 196, 0.8);
    }

    .nav-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand-logo-wrap {
      position: relative;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 18px;
      background: radial-gradient(circle at 20% 15%, #fff9f3 0%, #ffb86b 40%, #ff914d 84%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 16px 40px rgba(214, 139, 86, 0.6);
      position: relative;
      z-index: 1;
    }

    .brand-text-main {
      font-weight: 750;
      letter-spacing: 0.03em;
      font-size: 18px;
      white-space: nowrap;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: var(--text-soft);
      flex: 1;
      justify-content: center;
      min-width: 0;
    }

    .nav-links a {
      padding: 6px 11px;
      border-radius: 999px;
      position: relative;
      overflow: hidden;
      transition: color 0.18s ease, transform 0.12s ease;
    }

    .nav-links a:hover {
      color: var(--text-main);
      transform: translateY(-1px);
    }

    .nav-links a.active {
      color: var(--text-main);
      font-weight: 600;
      background: rgba(255, 237, 213, 0.9);
    }

    .nav-cta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      margin-left: auto;
    }

    .btn-outline {
      padding: 7px 16px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      background: rgba(255, 250, 244, 0.95);
      font-size: 13px;
      color: var(--text-soft);
      cursor: pointer;
      transition: all 0.18s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-outline:hover {
      border-color: var(--accent);
      color: var(--text-main);
      box-shadow: 0 14px 32px rgba(204, 145, 107, 0.28);
      transform: translateY(-1px);
      background: #fffaf5;
    }

    .btn-primary {
      padding: 8px 18px;
      border-radius: var(--radius-pill);
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: #4a251a;
      background-image: linear-gradient(135deg, #ffb86b, #ff914d);
      box-shadow: 0 18px 40px rgba(214, 139, 86, 0.65);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .nav-auth {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-auth-email {
      max-width: 160px;
      padding: 5px 10px;
      border-radius: var(--radius-pill);
      background: rgba(255, 250, 244, 0.95);
      border: 1px solid rgba(243, 217, 196, 0.9);
      font-size: 12px;
      color: #6b4532;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-auth-btn {
      border: none;
      background: transparent;
      font-size: 11px;
      color: #b05825;
      padding: 4px 7px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
      white-space: nowrap;
    }

    .nav-auth-btn:hover {
      background: rgba(255, 237, 213, 0.95);
      color: #7a3410;
    }

    @media (max-width: 880px) {
      .nav-links { display: none; }
      .nav-inner { align-items: flex-start; }
      .nav-cta { margin-left: 0; }
    }

    @media (max-width: 640px) {
      .nav-inner {
        padding: 8px 14px;
        gap: 6px;
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .brand { width: 100%; }
      .brand-logo {
        width: 34px;
        height: 34px;
        font-size: 20px;
      }
      .brand-text-main { font-size: 16px; }
      .brand-text-sub { font-size: 10px; }
      .nav-cta {
        width: 100%;
        justify-content: flex-end;
        gap: 6px;
      }
      .btn-outline,
      .btn-primary {
        padding: 6px 10px;
        font-size: 12px;
      }
      .nav-auth-email {
        max-width: 130px;
        font-size: 11px;
      }
    }

    /* Layout */

    main {
      max-width: 1120px;
      margin: 0 auto;
      padding: 22px 20px 40px;
    }

    .page-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 24px;
      margin-top: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .page-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      background: rgba(255, 222, 186, 0.9);
      color: #6b4532;
      font-size: 11px;
      margin-bottom: 10px;
      box-shadow: 0 10px 26px rgba(210, 145, 110, 0.28);
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff8f0 0%, #ff914d 55%, #d6632a 100%);
    }

    .hero-title {
      font-size: clamp(24px, 4.2vw, 34px);
      line-height: 1.18;
      margin-bottom: 12px;
      letter-spacing: 0.01em;
    }

    .hero-title span.highlight {
      background: linear-gradient(120deg, #ff914d, #ffb86b);
      -webkit-background-clip: text;
      color: transparent;
    }

    .hero-sub {
      font-size: 14px;
      color: var(--text-soft);
      line-height: 1.7;
      margin-bottom: 10px;
    }

    .hero-note {
      font-size: 12px;
      color: #a7714f;
      line-height: 1.6;
      margin-bottom: 18px;
    }

    .hero-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 18px;
    }

    .hero-pill {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: var(--radius-pill);
      background: rgba(255, 249, 243, 0.96);
      border: 1px solid rgba(243, 217, 196, 0.9);
      color: #7b4d3a;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .state-box {
      border-radius: var(--radius-md);
      padding: 14px 14px 12px;
      background: rgba(255, 248, 241, 0.98);
      border: 1px dashed rgba(243, 217, 196, 0.9);
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 14px;
    }

    .state-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-main);
    }

    .state-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Chat card */

    .chat-card {
      border-radius: var(--radius-lg);
      background: rgba(255, 246, 238, 0.98);
      border: 1px solid rgba(243, 217, 196, 0.9);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 260px;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
    }

    .chat-status-pill {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #15803d;
      font-size: 11px;
    }

    .chat-window {
      flex: 1;
      min-height: 140px;
      max-height: 380px;
      overflow-y: auto;
      padding: 10px;
      border-radius: 18px;
      background: rgba(255, 249, 243, 0.98);
      border: 1px solid rgba(243, 217, 196, 0.8);
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bubble {
      max-width: 88%;
      padding: 8px 10px;
      border-radius: 16px;
      line-height: 1.6;
      word-break: break-word;
    }

    .bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #ffb86b, #ff914d);
      color: #3b2217;
      border-bottom-right-radius: 4px;
    }

    .bubble.ai {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid rgba(243, 217, 196, 0.9);
      border-bottom-left-radius: 4px;
      color: var(--text-main);
    }

    .chat-input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      border-radius: 14px;
      border: 1px solid rgba(243, 217, 196, 0.9);
      background: #fffaf5;
      padding: 8px 10px;
      resize: vertical;
      min-height: 42px;
      max-height: 120px;
      font-size: 13px;
      font-family: inherit;
      color: var(--text-main);
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(255, 145, 77, 0.35);
    }

    .chat-send-btn {
      padding: 8px 14px;
      border-radius: var(--radius-pill);
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: #4a251a;
      background-image: linear-gradient(135deg, #ffb86b, #ff914d);
      box-shadow: 0 14px 30px rgba(214, 139, 86, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chat-send-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .system-note {
      font-size: 11px;
      color: var(--text-soft);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <div class="nav-inner">
      <a href="index.html" class="brand">
        <div class="brand-logo-wrap">
          <div class="brand-logo">üêæ</div>
        </div>
        <div>
          <div class="brand-text-main">CalmPaw Coach</div>
          <div class="brand-text-sub">Infinite AI trainer for real-life dogs</div>
        </div>
      </a>

      <nav class="nav-links">
        <a href="programs.html">Programs</a>
        <a href="bundle.html">Complete Pack</a>
        <a href="ai.html" class="active">AI Trainer</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>

      <div class="nav-cta">
        <div id="nav-auth-area">
          <a class="btn-outline" href="auth.html?redirect=/ai.html">
            üîë Log in
          </a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="page-grid">
      <div>
        <div class="chip">
          <div class="chip-dot"></div>
          $29/month ¬∑ infinite CalmPaw AI trainer
        </div>
        <h1 class="hero-title">
          Talk to a gentle <span class="highlight">AI trainer</span><br />
          built for small apartments, noisy neighbors & tired humans.
        </h1>
        <p class="hero-sub">
          Ask about barking at doors, visitors, alone time, leash walking,
          guilt, neighbor complaints and more ‚Äî in your own words, any time of
          day. CalmPaw AI replies with realistic, quiet-friendly ideas.
        </p>
        <p class="hero-note">
          This page checks your login + subscription automatically. No
          passwords inside the chat ‚Äî only dog behaviour and human-side
          questions.
        </p>

        <div class="hero-pill-row">
          <div class="hero-pill">üõã For real homes, not training halls</div>
          <div class="hero-pill">üì© Answer in minutes, not weeks</div>
          <div class="hero-pill">üîí Private ‚Äî just you and your AI trainer</div>
        </div>

        <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅ -->
        <div id="state-not-logged" class="state-box hidden">
          <div class="state-title">Log in to use the AI trainer</div>
          <p>
            Please log in with your email first. You‚Äôll come straight back to
            this page after signing in.
          </p>
          <div class="state-actions">
            <a class="btn-primary" href="auth.html?redirect=/ai.html">Log in / create account ‚Üí</a>
          </div>
        </div>

        <!-- Ê≤°ÊúâËÆ¢ÈòÖ -->
        <div id="state-no-sub" class="state-box hidden">
          <div class="state-title">$29/month ‚Äî infinite CalmPaw AI trainer</div>
          <p>
            You‚Äôre logged in, but don‚Äôt have an active AI Trainer subscription yet.
            Click below to start the monthly plan.
          </p>
          <div class="state-actions">
            <!-- TODO: Êää href Êç¢Êàê‰Ω†ÁöÑ Paddle ËÆ¢ÈòÖÈìæÊé• -->
            <a id="ai-subscribe-link" class="btn-primary" href="#">
              Subscribe for $29/month ‚Üí
            </a>
            <span class="system-note">
              After payment you‚Äôll be sent back here and the chat will unlock automatically.
            </span>
          </div>
        </div>

        <!-- Â∑≤ËÆ¢ÈòÖÂ∞èÊèêÁ§∫ -->
        <div id="state-active-info" class="state-box hidden">
          <div class="state-title">Your AI Trainer is active</div>
          <p>
            You have an active AI Trainer subscription. You can ask unlimited
            questions about your dog‚Äôs behaviour and your daily life with them.
          </p>
          <p class="system-note" id="sub-dates"></p>
        </div>
      </div>

      <!-- Chat Âç°Áâá -->
      <div class="chat-card" id="chat-card">
        <div class="chat-header">
          <div>
            <strong>CalmPaw AI Trainer</strong>
            <div style="font-size:11px; color:var(--text-soft);">
              Ask about barking, neighbors, alone-time, leash walking and more.
            </div>
          </div>
          <div class="chat-status-pill" id="chat-status-pill">
            Checking access‚Ä¶
          </div>
        </div>

        <div class="chat-window" id="chat-window">
          <div class="bubble ai">
            Hi, I‚Äôm your CalmPaw AI trainer. Tell me what‚Äôs happening at home ‚Äî
            the dog, the neighbors, your schedule ‚Äî and I‚Äôll help you find
            realistic, gentle steps.
          </div>
        </div>

        <form class="chat-input-row" id="chat-form">
          <textarea
            id="chat-input"
            class="chat-input"
            placeholder="Example: ‚ÄúMy dog barks at every sound in the hallway after 10 pm, and the neighbors are angry. I work late and feel guilty. What small steps can I start with?‚Äù"
          ></textarea>
          <button type="submit" class="chat-send-btn" id="chat-send-btn">
            Send
          </button>
        </form>

        <div class="system-note">
          CalmPaw AI cannot give legal or medical advice. It‚Äôs designed for
          everyday behaviour and human-side questions in normal homes.
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "https://calmpaw-auth.sophieinbg.workers.dev";

    const navAuthArea = document.getElementById("nav-auth-area");
    const stateNotLogged = document.getElementById("state-not-logged");
    const stateNoSub = document.getElementById("state-no-sub");
    const stateActiveInfo = document.getElementById("state-active-info");
    const chatCard = document.getElementById("chat-card");
    const chatStatusPill = document.getElementById("chat-status-pill");
    const subDates = document.getElementById("sub-dates");
    const chatWindow = document.getElementById("chat-window");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const chatSendBtn = document.getElementById("chat-send-btn");
    const subscribeLink = document.getElementById("ai-subscribe-link");

    let history = [
      {
        role: "assistant",
        content:
          "Hi, I‚Äôm your CalmPaw AI trainer. Tell me what‚Äôs happening at home ‚Äî the dog, the neighbors, your schedule ‚Äî and I‚Äôll help you find realistic, gentle steps.",
      },
    ];

    // TODO: ÊääËøôÈáåÁöÑÈìæÊé•Êç¢Êàê‰Ω†ÁöÑ Paddle ËÆ¢ÈòÖÈìæÊé•
    subscribeLink.href = "#";

    function formatDate(tsSec) {
      if (!tsSec) return "";
      const d = new Date(tsSec * 1000);
      return d.toLocaleDateString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    function appendBubble(role, text) {
      const div = document.createElement("div");
      div.className = "bubble " + (role === "user" ? "user" : "ai");
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function setChatEnabled(enabled) {
      chatInput.disabled = !enabled;
      chatSendBtn.disabled = !enabled;
    }

    async function hydrateNavAuth() {
      const token = localStorage.getItem("calmpaw_token");
      const email = localStorage.getItem("calmpaw_email");

      if (!token) {
        navAuthArea.innerHTML = `
          <a class="btn-outline" href="auth.html?redirect=${encodeURIComponent(
            "/ai.html"
          )}">
            üîë Log in
          </a>`;
        stateNotLogged.classList.remove("hidden");
        chatStatusPill.textContent = "Please log in";
        setChatEnabled(false);
        return;
      }

      try {
        const res = await fetch(API_BASE + "/auth/me", {
          headers: { Authorization: "Bearer " + token },
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          localStorage.removeItem("calmpaw_token");
          localStorage.removeItem("calmpaw_email");
          navAuthArea.innerHTML = `
            <a class="btn-outline" href="auth.html?redirect=${encodeURIComponent(
              "/ai.html"
            )}">
              üîë Log in
            </a>`;
          stateNotLogged.classList.remove("hidden");
          chatStatusPill.textContent = "Please log in";
          setChatEnabled(false);
          return;
        }

        const showEmail = email || data.email || "Member";
        navAuthArea.innerHTML = `
          <div class="nav-auth">
            <span class="nav-auth-email" title="${showEmail}">${showEmail}</span>
            <button class="nav-auth-btn" id="nav-switch-account">Switch</button>
            <button class="nav-auth-btn" id="nav-logout">Log out</button>
          </div>
        `;

        document
          .getElementById("nav-switch-account")
          .addEventListener("click", () => {
            localStorage.removeItem("calmpaw_token");
            localStorage.removeItem("calmpaw_email");
            window.location.href =
              "auth.html?redirect=" + encodeURIComponent("/ai.html");
          });

        document
          .getElementById("nav-logout")
          .addEventListener("click", () => {
            localStorage.removeItem("calmpaw_token");
            localStorage.removeItem("calmpaw_email");
            window.location.href = "/index.html";
          });

        // ÁôªÂΩïÊàêÂäü ‚Üí Ê£ÄÊü•ËÆ¢ÈòÖ
        stateNotLogged.classList.add("hidden");
        await checkSubscription();
      } catch (e) {
        console.error(e);
        chatStatusPill.textContent = "Error checking login";
        setChatEnabled(false);
      }
    }

    async function checkSubscription() {
      const token = localStorage.getItem("calmpaw_token");
      if (!token) return;

      chatStatusPill.textContent = "Checking subscription‚Ä¶";
      setChatEnabled(false);

      try {
        const res = await fetch(API_BASE + "/ai/status", {
          headers: { Authorization: "Bearer " + token },
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          stateNoSub.classList.remove("hidden");
          stateActiveInfo.classList.add("hidden");
          chatStatusPill.textContent = "No active subscription";
          setChatEnabled(false);
          return;
        }

        if (data.subscribed && data.status === "active") {
          stateNoSub.classList.add("hidden");
          stateActiveInfo.classList.remove("hidden");
          subDates.textContent =
            "Active from " +
            formatDate(data.started_at) +
            " to " +
            formatDate(data.active_until) +
            ".";
          chatStatusPill.textContent = "AI Trainer active";
          setChatEnabled(true);
        } else {
          stateNoSub.classList.remove("hidden");
          stateActiveInfo.classList.add("hidden");
          chatStatusPill.textContent = "No active subscription";
          setChatEnabled(false);
        }
      } catch (e) {
        console.error(e);
        chatStatusPill.textContent = "Error checking subscription";
        setChatEnabled(false);
      }
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      const token = localStorage.getItem("calmpaw_token");
      if (!token) {
        alert("Please log in first.");
        return;
      }

      appendBubble("user", text);
      history.push({ role: "user", content: text });
      chatInput.value = "";
      setChatEnabled(false);
      chatStatusPill.textContent = "Thinking‚Ä¶";

      try {
        const res = await fetch(API_BASE + "/ai/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({
            message: text,
            history: history.slice(-8), // ÊúÄËøëÂá†Êù°
          }),
        });

        if (res.status === 403) {
          chatStatusPill.textContent = "No active subscription";
          stateNoSub.classList.remove("hidden");
          stateActiveInfo.classList.add("hidden");
          setChatEnabled(false);
          appendBubble(
            "ai",
            "Your AI Trainer subscription is not active right now. Please renew the plan to keep chatting."
          );
          return;
        }

        const data = await res.json();
        if (!res.ok || !data.ok) {
          chatStatusPill.textContent = "Error";
          appendBubble(
            "ai",
            "Sorry, something went wrong on the server. Please try again in a moment."
          );
          setChatEnabled(true);
          return;
        }

        const reply = data.reply || "‚Ä¶";
        appendBubble("ai", reply);
        history.push({ role: "assistant", content: reply });
        chatStatusPill.textContent = "AI Trainer active";
        setChatEnabled(true);
      } catch (e) {
        console.error(e);
        chatStatusPill.textContent = "Error";
        appendBubble(
          "ai",
          "I couldn‚Äôt reach the server just now. Please check your connection and try again."
        );
        setChatEnabled(true);
      }
    });

    document.addEventListener("DOMContentLoaded", hydrateNavAuth);
  </script>
</body>
</html>
