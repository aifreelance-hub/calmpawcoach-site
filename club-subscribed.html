<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw Reading Club ‚Äî Your Monthly Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:#fff7f0;--accent:#ffb86b;--accent-strong:#ff914d;
      --text-main:#3b2824;--text-soft:#8a6a63;
      --border-soft:#f3d9c4;--radius-lg:26px;--radius-md:18px;
      --shadow-soft:0 26px 60px rgba(210,145,110,0.35);
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,"Segoe UI",sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at 5% 0%, #ffe0c0 0%, transparent 55%),
        radial-gradient(circle at 100% 0%, #ffd4d4 0%, transparent 55%),
        linear-gradient(180deg,#fff7f0 0%,#fff2e7 40%,#fff8f2 100%);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }
    a{text-decoration:none;color:inherit;}
    header{
      border-bottom:1px solid rgba(243,217,196,0.9);
      backdrop-filter:blur(18px);
      background:rgba(255,248,240,0.92);
    }
    .nav-inner{
      max-width:1120px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0;}
    .brand-logo{
      width:38px;height:38px;border-radius:18px;
      background:radial-gradient(circle at 20% 15%,#fff9f3 0%,#ffb86b 40%,#ff914d 84%);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 16px 40px rgba(214,139,86,0.6);
      font-size:22px;
    }
    .brand-main{font-weight:750;font-size:18px;letter-spacing:0.03em;}
    .brand-sub{font-size:11px;color:var(--text-soft);}
    .nav-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .nav-email{
      max-width:170px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:rgba(255,250,244,0.95);
      font-size:11px;
      color:#6b4532;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .nav-btn{
      border:none;background:transparent;
      font-size:11px;color:#b05825;padding:4px 7px;
      border-radius:999px;cursor:pointer;
    }
    .nav-btn:hover{background:rgba(255,237,213,0.95);color:#7a3410;}
    main{
      max-width:1120px;
      margin:0 auto;
      padding:22px 18px 32px;
    }
    @media(max-width:640px){
      .nav-inner{padding:8px 14px;}
      main{padding:18px 14px 26px;}
      .brand-main{font-size:16px;}
      .brand-sub{font-size:10px;}
    }
    .hero{
      margin-top:12px;
      margin-bottom:22px;
      display:grid;
      grid-template-columns:minmax(0,1.6fr) minmax(0,1.2fr);
      gap:22px;
      align-items:flex-start;
    }
    @media(max-width:880px){
      .hero{grid-template-columns:minmax(0,1fr);}
    }
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 12px;border-radius:999px;
      background:rgba(255,222,186,0.95);
      font-size:11px;color:#6b4532;
      box-shadow:0 10px 26px rgba(210,145,110,0.28);
      margin-bottom:8px;
    }
    .chip-dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fff8f0 0%,#ff914d 55%,#d6632a 100%);
    }
    h1{
      font-size:clamp(22px,3.8vw,30px);
      margin-bottom:8px;
    }
    .hero-sub{
      font-size:13px;color:var(--text-soft);
      line-height:1.7;margin-bottom:10px;
    }
    .hero-meta{
      font-size:12px;color:#a7714f;margin-bottom:4px;
    }
    .meta-strong{font-weight:600;color:#b05825;}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background:rgba(255,249,243,0.98);
      border:1px solid rgba(243,217,196,0.9);
      font-size:11px;color:#7b4d3a;
      margin-top:4px;
    }
    .current-issue-card{
      border-radius:var(--radius-lg);
      background:rgba(255,246,238,0.98);
      border:1px solid rgba(243,217,196,0.9);
      box-shadow:var(--shadow-soft);
      padding:16px 16px 14px;
    }
    .issue-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#b48363;
      margin-bottom:4px;
    }
    .issue-title{
      font-size:17px;
      font-weight:600;
      margin-bottom:4px;
    }
    .issue-tagline{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }
    .issue-meta-row{
      display:flex;flex-wrap:wrap;gap:10px;
      font-size:11px;color:#8a6a63;margin-bottom:10px;
    }
    .issue-meta-pill{
      padding:4px 9px;
      border-radius:999px;
      background:rgba(255,249,243,0.98);
      border:1px dashed rgba(210,145,111,0.7);
    }
    .issue-body{
      font-size:13px;
      color:var(--text-main);
      line-height:1.7;
      margin-bottom:10px;
    }
    .issue-actions{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
      margin-top:4px;
    }
    .btn-primary{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 16px;border-radius:999px;
      border:none;background-image:linear-gradient(135deg,#ffb86b,#ff914d);
      color:#4a251a;font-size:13px;font-weight:600;
      box-shadow:0 18px 40px rgba(214,139,86,0.65);
      cursor:pointer;
    }
    .btn-secondary{
      display:inline-flex;align-items:center;gap:4px;
      padding:6px 12px;border-radius:999px;
      border:1px solid var(--border-soft);
      background:rgba(255,250,244,0.96);
      font-size:12px;color:#7b4d3a;
      cursor:pointer;
    }
    .small-note{
      font-size:11px;color:var(--text-soft);
      margin-top:4px;
    }
    .timeline{
      margin-top:20px;
      border-radius:var(--radius-md);
      padding:12px 14px 10px;
      background:rgba(255,250,244,0.98);
      border:1px dashed rgba(243,217,196,0.9);
      font-size:11px;color:#7b4d3a;
    }
    .timeline-title{font-weight:600;margin-bottom:6px;font-size:12px;}
    .timeline-list{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:8px;}
    .timeline-item{
      padding:4px 9px;border-radius:999px;
      border:1px solid rgba(243,217,196,0.9);
      background:#fffaf5;
    }
    .timeline-item.current{
      border-color:#ff914d;
      background:rgba(255,232,204,0.98);
      font-weight:600;
    }
    .status-box{
      margin-top:18px;
      font-size:11px;
      color:var(--text-soft);
    }
    .status-box span{color:#b05825;font-weight:600;}
    .hidden{display:none;}
  </style>
</head>
<body>
  <header>
    <div class="nav-inner">
      <a href="index.html" class="brand">
        <div class="brand-logo">üêæ</div>
        <div>
          <div class="brand-main">CalmPaw Coach</div>
          <div class="brand-sub">Reading Club member area</div>
        </div>
      </a>
      <div class="nav-right">
        <div id="nav-email" class="nav-email">Loading‚Ä¶</div>
        <button class="nav-btn" id="btn-club-home">Back to club page</button>
        <button class="nav-btn" id="btn-logout">Log out</button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div>
        <div class="chip">
          <span class="chip-dot"></span>
          CalmPaw Reading Club ¬∑ member
        </div>
        <h1>Your monthly Calm Home Reader</h1>
        <p class="hero-sub">
          This page always shows your current month‚Äôs reader based on when you joined.
          Each new month unlocks a new topic ‚Äî no extra login, no extra steps.
        </p>
        <p class="hero-meta">
          Joined: <span class="meta-strong" id="joined-date">‚Äî</span><br />
          Current cycle: <span class="meta-strong" id="cycle-label">‚Äî</span>
        </p>
        <div class="badge">
          <span>üõã</span> Quiet reading for tired humans & real-life dogs
        </div>
      </div>

      <article class="current-issue-card" id="issue-card">
        <div class="issue-label" id="issue-label">MONTH 1 ¬∑ DOORS & NEIGHBORS</div>
        <h2 class="issue-title" id="issue-title">Doors, neighbors & the ‚Äúwho is out there?‚Äù dog</h2>
        <p class="issue-tagline" id="issue-tagline">
          Real apartment stories about dogs who care too much about the hallway.
        </p>

        <div class="issue-meta-row">
          <div class="issue-meta-pill" id="issue-pages">20‚Äì25 pages ¬∑ PDF</div>
          <div class="issue-meta-pill" id="issue-theme">Theme: Calm around doors & sounds</div>
        </div>

        <p class="issue-body" id="issue-summary">
          Each month you receive one Calm Home Reader. This month focuses on door sounds,
          neighbors in the hallway and that ‚Äúbodyguard‚Äù feeling many city dogs develop.
          The reader mixes real stories, gentle training theory and human-side notes.
        </p>

        <div class="issue-actions">
          <a id="issue-download" href="#" class="btn-primary" target="_blank" rel="noopener">
            Download this month‚Äôs PDF <span>‚Üì</span>
          </a>
          <button id="issue-open" class="btn-secondary">
            Open in a new tab
          </button>
        </div>
        <div class="small-note" id="issue-note">
          If the PDF doesn‚Äôt open, please check your browser‚Äôs pop-up settings or
          contact support with your email address.
        </div>
      </article>
    </section>

    <section class="timeline">
      <div class="timeline-title">Your Reading Club timeline</div>
      <ul class="timeline-list" id="timeline-list">
        <!-- JS Ê≥®ÂÖ•ÊØè‰∏™ÊúàÁöÑÊ†áÁ≠æÔºåÂ¶Ç Month 1, Month 2 ... -->
      </ul>
    </section>

    <section class="status-box" id="status-box">
      Subscription status: <span id="status-text">Checking‚Ä¶</span><br />
      Access valid until: <span id="until-text">‚Äî</span>
    </section>
  </main>

  <script>
    const API_BASE = "https://calmpaw-auth.sophieinbg.workers.dev";

    // ‰Ω†ÂèØ‰ª•ÊåâÈúÄË¶Å‰øÆÊîπËøô‰∫õ PDF Ë∑ØÂæÑÂíåÊñáÊ°à
    const ISSUES = [
      {
        slug: "month1",
        label: "Month 1",
        labelFull: "Month 1 ¬∑ Doors & neighbors",
        title: "Doors, neighbors & the ‚Äúwho is out there?‚Äù dog",
        tagline: "Real apartment stories about dogs who care too much about the hallway.",
        pages: "20‚Äì25 pages ¬∑ PDF",
        theme: "Theme: Calm around doors & sounds",
        summary:
          "We look at why door sounds, footsteps and voices in the hallway trigger so many dogs, and which small, realistic routines help your dog feel safer at home.",
        pdfUrl: "/assets/club/calm-home-reader-01-doors-neighbors.pdf"
      },
      {
        slug: "month2",
        label: "Month 2",
        labelFull: "Month 2 ¬∑ Alone-time & coming home",
        title: "Alone-time, coming home & ‚Äúguilty dog‚Äù feelings",
        tagline: "Stories from dogs who struggle when humans leave or return.",
        pages: "22‚Äì28 pages ¬∑ PDF",
        theme: "Theme: Separation & reunions",
        summary:
          "We explore dogs who find alone-time hard, and humans who carry guilt. The stories and notes help you adjust routines and expectations without perfectionism.",
        pdfUrl: "/assets/club/calm-home-reader-02-alone-time.pdf"
      },
      {
        slug: "month3",
        label: "Month 3",
        labelFull: "Month 3 ¬∑ City walks & busy streets",
        title: "City walks, busy streets & looking after both of you",
        tagline: "Realistic walks for dogs and humans who live in noisy places.",
        pages: "20‚Äì30 pages ¬∑ PDF",
        theme: "Theme: Street confidence & pacing",
        summary:
          "We look at pulling, scanning and ‚Äútoo much input‚Äù on city walks, plus the human-side part: energy after work, decision fatigue and what a ‚Äògood enough‚Äô walk can be.",
        pdfUrl: "/assets/club/calm-home-reader-03-city-walks.pdf"
      }
      // ‰ª•ÂêéÂèØ‰ª•ÁªßÁª≠ÂæÄÊï∞ÁªÑÈáåÂä† Month 4, Month 5 ...
    ];

    function formatDateFromUnix(sec) {
      if (!sec) return "‚Äî";
      const d = new Date(sec * 1000);
      const opts = { year: "numeric", month: "short", day: "numeric" };
      return d.toLocaleDateString("en-US", opts);
    }

    function computeCycleIndex(startedAtSec) {
      if (!startedAtSec) return 0;
      const now = Date.now();
      const started = startedAtSec * 1000;
      const diffMs = now - started;
      const msPerMonth = 30 * 24 * 60 * 60 * 1000; // ÁÆÄÂçïÊåâ30Â§©‰∏ÄÊúà
      let months = Math.floor(diffMs / msPerMonth);
      if (months < 0) months = 0;
      // Â¶ÇÊûúË∂ÖËøá‰Ω†È¢ÑËÆæÁöÑÊúüÊï∞ÔºåÂ∞±‰∏ÄÁõ¥ÊòæÁ§∫ÊúÄÂêé‰∏ÄÊúü
      if (months >= ISSUES.length) months = ISSUES.length - 1;
      return months;
    }

    function renderTimeline(currentIndex) {
      const list = document.getElementById("timeline-list");
      list.innerHTML = "";
      ISSUES.forEach((issue, idx) => {
        const li = document.createElement("li");
        li.className = "timeline-item" + (idx === currentIndex ? " current" : "");
        li.textContent = issue.label;
        list.appendChild(li);
      });
    }

    function renderIssue(issue, cycleIndex) {
      document.getElementById("issue-label").textContent = issue.labelFull;
      document.getElementById("issue-title").textContent = issue.title;
      document.getElementById("issue-tagline").textContent = issue.tagline;
      document.getElementById("issue-pages").textContent = issue.pages;
      document.getElementById("issue-theme").textContent = issue.theme;
      document.getElementById("issue-summary").textContent = issue.summary;

      const downloadLink = document.getElementById("issue-download");
      const openBtn = document.getElementById("issue-open");
      downloadLink.href = issue.pdfUrl;
      openBtn.onclick = () => {
        window.open(issue.pdfUrl, "_blank");
      };

      document.getElementById("cycle-label").textContent = issue.label + " (cycle " + (cycleIndex + 1) + ")";
    }

    async function loadClubPage() {
      const emailEl = document.getElementById("nav-email");
      const statusText = document.getElementById("status-text");
      const untilText = document.getElementById("until-text");
      const joinedDateEl = document.getElementById("joined-date");

      const token = localStorage.getItem("calmpaw_token");
      if (!token) {
        window.location.href = "auth.html?redirect=" + encodeURIComponent("/club-subscribed.html");
        return;
      }

      try {
        // ÊòæÁ§∫ÈÇÆÁÆ±
        const meRes = await fetch(API_BASE + "/auth/me", {
          headers: { "Authorization": "Bearer " + token }
        });
        const meData = await meRes.json();
        if (!meRes.ok || !meData.ok) {
          window.location.href = "auth.html?redirect=" + encodeURIComponent("/club-subscribed.html");
          return;
        }
        const email = meData.email || "Member";
        emailEl.textContent = email;
        emailEl.title = email;

        // ËØªÂèñËÆ¢ÈòÖÁä∂ÊÄÅ
        const statusRes = await fetch(API_BASE + "/club/status", {
          headers: { "Authorization": "Bearer " + token }
        });
        const statusData = await statusRes.json();

        if (!statusRes.ok || !statusData.ok || !statusData.subscribed) {
          // Êú™ËÆ¢ÈòÖÊàñÂ∑≤ËøáÊúü ‚Üí ÂõûÈîÄÂîÆÈ°µ
          window.location.href = "/club.html";
          return;
        }

        const startedAt = statusData.started_at;     // ÂêéÁ´ØÈúÄË¶ÅËøîÂõû started_atÔºàÁßíÔºâ
        const activeUntil = statusData.active_until; // ÂèØÈÄâÔºå‰ΩÜÊé®Ëçê
        const humanStatus = statusData.status || "active";

        joinedDateEl.textContent = formatDateFromUnix(startedAt);
        untilText.textContent = activeUntil ? formatDateFromUnix(activeUntil) : "‚Äî";
        statusText.textContent = humanStatus === "active" ? "Active Reading Club membership" : humanStatus;

        const cycleIndex = computeCycleIndex(startedAt);
        const currentIssue = ISSUES[cycleIndex];
        renderIssue(currentIssue, cycleIndex);
        renderTimeline(cycleIndex);

      } catch (e) {
        console.error(e);
        statusText.textContent = "We could not load your membership. Please try again.";
      }
    }

    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.removeItem("calmpaw_token");
      localStorage.removeItem("calmpaw_email");
      window.location.href = "/index.html";
    });
    document.getElementById("btn-club-home").addEventListener("click", () => {
      window.location.href = "/club.html";
    });

    document.addEventListener("DOMContentLoaded", loadClubPage);
  </script>
</body>
</html>
