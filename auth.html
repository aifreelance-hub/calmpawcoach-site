<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CalmPaw Coach ‚Äî Sign in to your training plans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      padding: 18px;
      background: radial-gradient(circle at top, #fed7aa 0%, #fff7ed 40%, #fffbeb 100%);
      color: #111827;
    }
    .card {
      width: 100%; max-width: 460px;
      padding: 22px 24px;
      border-radius: 26px;
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(18px);
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.18),
        0 0 1px rgba(148, 163, 184, 0.7);
      border: 1px solid rgba(248, 250, 252, 0.9);
    }

    .top-row { display: flex; justify-content: flex-end; margin-bottom: 6px; }
    .back-link {
      font-size: 11px; color: #6b7280;
      padding: 4px 9px; border-radius: 999px;
      display: inline-flex; gap: 4px; cursor: pointer;
      background: #f9fafb; border: 1px solid rgba(229, 231, 235, 0.9);
      text-decoration: none;
    }

    .brand { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .brand-icon {
      width: 32px; height: 32px; border-radius: 999px;
      background: conic-gradient(from 200deg, #fb923c, #f97316, #fed7aa);
      display: flex; align-items: center; justify-content: center;
      font-size: 17px; color: #fff;
    }
    .brand-name { font-size: 15px; text-transform: uppercase; color: #7c2d12; }
    .brand-sub { font-size: 12px; color: #9a3412; }

    h1 { font-size: 22px; margin-top: 8px; margin-bottom: 6px; }
    .subtitle { font-size: 13px; color: #6b7280; margin-bottom: 16px; }

    .tabs { display: flex; gap: 6px; margin-bottom: 14px; padding: 3px; border-radius: 999px; background: #fef3c7; }
    .tab-btn { flex: 1; border: none; background: transparent; padding: 8px 10px; font-size: 13px; border-radius: 999px; }
    .tab-btn.active { background: #fff7ed; box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.35); font-weight: 600; }

    .form { display: none; flex-direction: column; gap: 10px; margin-top: 6px; }
    .form.active { display: flex; }

    label { font-size: 12px; color: #4b5563; margin-bottom: 2px; display: block; }

    input {
      width: 100%; padding: 9px 11px;
      border-radius: 999px; border: 1px solid #e5e7eb;
      background: #f9fafb; font-size: 14px;
    }
    input:focus { border-color: #f97316; background: #fff; }

    .field-inline { display: flex; gap: 8px; align-items: center; }
    .field-inline input { flex: 1; }

    .btn {
      padding: 9px 14px; border-radius: 999px; font-size: 14px;
      border: none; cursor: pointer; display: flex; justify-content: center;
      transition: transform 0.08s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff; width: 100%; box-shadow: 0 10px 25px rgba(248, 113, 22, 0.4);
    }
    .btn-ghost { background: transparent; font-size: 12px; color: #92400e; }

    .hint { font-size: 11px; color: #6b7280; margin-top: 4px; }

    .status { margin-top: 8px; font-size: 12px; min-height: 16px; }
    .status.ok { color: #166534; }
    .status.err { color: #b91c1c; }

    .footer { margin-top: 12px; font-size: 11px; text-align: center; color: #9ca3af; }
    .footer span { color: #f97316; }
  </style>
</head>
<body>

  <div class="card">
    <div class="top-row">
      <a href="index.html" class="back-link"><span>‚Üê</span> Back to CalmPaw home</a>
    </div>

    <div class="brand">
      <div class="brand-icon">üêæ</div>
      <div>
        <div class="brand-name">CalmPaw Coach</div>
        <div class="brand-sub">Gentle, realistic dog training</div>
      </div>
    </div>

    <h1>Sign in to your training plans</h1>
    <p class="subtitle">Use one account to access all your purchased CalmPaw Coach programs.</p>

    <div class="tabs">
      <button class="tab-btn active" data-tab="login">Log in</button>
      <button class="tab-btn" data-tab="register">Create account</button>
      <button class="tab-btn" data-tab="reset">Reset password</button>
    </div>

    <!-- Login -->
    <div class="form active" id="form-login">
      <div class="field">
        <label>Email</label>
        <input id="login-email" type="email" placeholder="you@example.com" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="login-password" type="password" placeholder="At least 8 characters" />
      </div>
      <button class="btn btn-primary" id="btn-login">Log in</button>

      <div class="field" style="font-size:12px;margin-top:6px;color:#6b7280;">
        New here? <a href="#" id="link-to-register">Create account</a> ¬∑
        <a href="#" id="link-to-reset">Forgot password?</a>
      </div>
    </div>

    <!-- Register -->
    <div class="form" id="form-register">
      <div class="field">
        <label>Email</label>
        <input id="reg-email" type="email" placeholder="you@example.com" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="reg-password" type="password" placeholder="At least 8 characters" />
      </div>

      <div class="field">
        <label>Verification code</label>
        <div class="field-inline">
          <input id="reg-code" type="text" placeholder="6-digit code" />
          <button class="btn btn-ghost" id="btn-send-reg-code">Send code</button>
        </div>
      </div>

      <button class="btn btn-primary" id="btn-register">Create account & sign in</button>
    </div>

    <!-- Reset -->
    <div class="form" id="form-reset">
      <div class="field">
        <label>Email</label>
        <input id="reset-email" type="email" placeholder="you@example.com" />
      </div>
      <div class="field">
        <label>New password</label>
        <input id="reset-password" type="password" placeholder="At least 8 characters" />
      </div>

      <div class="field">
        <label>Reset code</label>
        <div class="field-inline">
          <input id="reset-code" type="text" placeholder="6-digit code" />
          <button class="btn btn-ghost" id="btn-send-reset-code">Send reset code</button>
        </div>
      </div>

      <button class="btn btn-primary" id="btn-reset">Set new password & sign in</button>
    </div>

    <div id="status" class="status"></div>
    <div class="footer">This account only controls <span>access</span> to your plans.</div>
  </div>

<script>
const API_BASE = "https://calmpaw-auth.sophieinbg.workers.dev";

// -------- Tabs --------
const tabs = document.querySelectorAll(".tab-btn");
const forms = {
  login: document.getElementById("form-login"),
  register: document.getElementById("form-register"),
  reset: document.getElementById("form-reset"),
};

tabs.forEach(btn => btn.addEventListener("click", () => {
  tabs.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  Object.keys(forms).forEach(k => forms[k].classList.remove("active"));
  forms[btn.dataset.tab].classList.add("active");
}));

document.getElementById("link-to-register").onclick = e => {
  e.preventDefault();
  tabs[1].click();
};
document.getElementById("link-to-reset").onclick = e => {
  e.preventDefault();
  tabs[2].click();
};

// -------- Helpers --------
const statusEl = document.getElementById("status");

function showStatus(msg, type="ok") {
  statusEl.textContent = msg;
  statusEl.className = "status " + type;
}

function setLoading(btn, loading) {
  if (!btn) return;
  if (loading) {
    btn.dataset.old = btn.textContent;
    btn.textContent = "Working‚Ä¶";
    btn.disabled = true;
  } else {
    btn.textContent = btn.dataset.old;
    btn.disabled = false;
  }
}

// -------- Redirect after login --------
function getRedirectPath() {
  const params = new URLSearchParams(window.location.search);
  return params.get("redirect") || "/index.html";  // ‚òÖ ÈªòËÆ§Ë∑≥È¶ñÈ°µ
}

function finishLogin(token, email) {
  localStorage.setItem("calmpaw_token", token);
  localStorage.setItem("calmpaw_email", email);
  window.location.href = getRedirectPath();
}

// -------- Send Code (Register) --------
document.getElementById("btn-send-reg-code").onclick = async () => {
  const email = document.getElementById("reg-email").value.trim();
  if (!email) return showStatus("Please enter email.", "err");

  const btn = document.getElementById("btn-send-reg-code");
  setLoading(btn, true);

  try {
    const res = await fetch(API_BASE + "/auth/send-code", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, purpose: "register" })
    });
    const data = await res.json();
    showStatus(data.ok ? "Code sent!" : data.error, data.ok ? "ok" : "err");
  } catch {
    showStatus("Network error.", "err");
  }
  setLoading(btn, false);
};

// -------- Register --------
document.getElementById("btn-register").onclick = async () => {
  const email = document.getElementById("reg-email").value.trim();
  const password = document.getElementById("reg-password").value.trim();
  const code = document.getElementById("reg-code").value.trim();

  if (!email || !password || !code)
    return showStatus("All fields required.", "err");

  const btn = document.getElementById("btn-register");
  setLoading(btn, true);

  try {
    const res = await fetch(API_BASE + "/auth/register", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, password, code })
    });
    const data = await res.json();
    if (data.ok) finishLogin(data.token, data.email);
    else showStatus(data.error, "err");
  } catch {
    showStatus("Network error.", "err");
  }
  setLoading(btn, false);
};

// -------- Login --------
document.getElementById("btn-login").onclick = async () => {
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value.trim();

  if (!email || !password)
    return showStatus("Fill email & password.", "err");

  const btn = document.getElementById("btn-login");
  setLoading(btn, true);

  try {
    const res = await fetch(API_BASE + "/auth/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (data.ok) finishLogin(data.token, data.email);
    else showStatus(data.error, "err");
  } catch {
    showStatus("Network error.", "err");
  }
  setLoading(btn, false);
};

// -------- Reset - send code --------
document.getElementById("btn-send-reset-code").onclick = async () => {
  const email = document.getElementById("reset-email").value.trim();
  if (!email) return showStatus("Enter your email.", "err");

  const btn = document.getElementById("btn-send-reset-code");
  setLoading(btn, true);

  try {
    const res = await fetch(API_BASE + "/auth/send-code", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, purpose: "reset" })
    });
    const data = await res.json();
    showStatus(data.ok ? "Reset code sent!" : data.error, data.ok ? "ok" : "err");
  } catch {
    showStatus("Network error.", "err");
  }

  setLoading(btn, false);
};

// -------- Reset password --------
document.getElementById("btn-reset").onclick = async () => {
  const email = document.getElementById("reset-email").value.trim();
  const password = document.getElementById("reset-password").value.trim();
  const code = document.getElementById("reset-code").value.trim();

  if (!email || !password || !code)
    return showStatus("All fields required.", "err");

  const btn = document.getElementById("btn-reset");
  setLoading(btn, true);

  try {
    const res = await fetch(API_BASE + "/auth/reset-password", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, password, code })
    });
    const data = await res.json();
    if (data.ok) finishLogin(data.token, data.email);
    else showStatus(data.error, "err");
  } catch {
    showStatus("Network error.", "err");
  }

  setLoading(btn, false);
};
</script>

</body>
</html>
